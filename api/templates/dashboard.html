<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Teacher Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:1100px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .item{border:1px solid #e3e3e3;border-radius:10px;padding:12px;margin:10px 0;background:#fafafa}
    .row{margin:6px 0}
    .label{color:#666;width:260px;display:inline-block;vertical-align:top}
    .val{display:inline-block;white-space:pre-wrap}
    .score-high{color:#0a8a0a;font-weight:700}
    .score-low{color:#c00;font-weight:700}
    .muted{color:#999}
    .chip{display:inline-block;background:#eee;border-radius:12px;padding:2px 8px;margin:2px}
    a{color:#333}
  </style>
</head>
<body>
  <div class="topbar">
    <h2>실시간 제출 현황</h2>
    <div><a href="/teacher-logout">로그아웃</a></div>
  </div>

  <div id="list"></div>
  <div id="status" class="muted">대기 중...</div>

  <script>
    let lastId = 0;
    const list = document.getElementById('list');
    const statusEl = document.getElementById('status');

    function scoreClass(s){
      if(typeof s !== 'number') return 'score-low';
      return s >= 7.0 ? 'score-high' : 'score-low';
    }
    function toChips(arr){
      if(!Array.isArray(arr) || arr.length === 0) return '<span class="muted">-</span>';
      return arr.map(x=>`<span class="chip">${x}</span>`).join(' ');
    }
    function appendItem(it){
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="row"><span class="label">제출 ID</span><span class="val">${it.id}</span></div>
        <div class="row"><span class="label">학생 ID</span><span class="val">${it.student_id || '-'}</span></div>
        <div class="row"><span class="label">채점 점수</span>
          <span class="val ${scoreClass(it.score)}">${(it.score ?? '-')}</span>
        </div>
        <div class="row"><span class="label">한국어 원문</span><span class="val">${it.original_korean_question || '-'}</span></div>
        <div class="row"><span class="label">학생 답안(이탈리아어)</span><span class="val">${it.student_answer_original || it.student_answer || '-'}</span></div>
        <div class="row"><span class="label">학생 답안의 한국어 번역</span><span class="val">${it.student_answer_korean_translation || '-'}</span></div>
        <div class="row"><span class="label">핵심 어휘(이탈리아어)</span><span class="val">${toChips(it.key_phrases_italian)}</span></div>
        <div class="row"><span class="label">핵심 어휘의 한국어 뜻</span><span class="val">${toChips(it.key_phrases_korean_translation)}</span></div>
      `;
      list.appendChild(div);
    }
    async function fetchNew(){
      try{
        const res = await fetch('/api/submissions?since_id=' + lastId, {cache:'no-store'});
        if(!res.ok){
          statusEl.textContent = '접근 권한이 없습니다. 다시 로그인 해 주세요.';
          return;
        }
        const data = await res.json();
        if(Array.isArray(data.items) && data.items.length){
          data.items.forEach(it=>{
            appendItem(it);
            if(it.id > lastId) lastId = it.id;
          });
          statusEl.textContent = '업데이트됨: ' + new Date().toLocaleTimeString();
        }
      }catch(e){
        statusEl.textContent = '연결 오류. 재시도 중...';
      }
    }
    // 최초 로드 + 2초마다 자동 갱신(페이지 새로고침 없이)
    (async () => {
      await fetchNew();
      setInterval(fetchNew, 2000);
    })();
  </script>
</body>
</html>