<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 대시보드</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 1rem; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        h1 { color: #ffffff; margin: 0; }
        .controls { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center; }
        .controls button { color: white; border: 1px solid #555; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 1rem; background-color: #333; transition: background-color 0.2s, border-color 0.2s; }
        .controls button.active { background-color: #7289da; border-color: #7289da; font-weight: bold; }
        .controls button:hover:not(.active) { background-color: #444; }
        #clear-btn { background-color: #c0392b; border: 1px solid #c0392b; }
        #clear-btn:hover { background-color: #e74c3c; border-color: #e74c3c; }
        #logout-btn { background-color: #555; border: none; }
        #logout-btn:hover { background-color: #777; }
        
        .view-container { display: none; }
        .view-container.active { display: block; }
        
        .submission-card { background-color: #2c2c2c; 
            border: 1px solid #444; 
            border-radius: 8px; 
            margin-bottom: 1.5rem; 
            overflow: hidden; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        .card-main-content { padding: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 1rem; }
        .student-info { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 0.8rem; }
        .student-info .id { color: #87ceeb; }
        .class-badge { background-color: #4f545c; color: #e0e0e0; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.8rem; font-weight: normal; }
        .score { font-size: 2rem; font-weight: bold; }
        .score.high { color: #4CAF50; }
        .score.low { color: #F44336; }
        .card-body p { margin: 0.8rem 0; line-height: 1.6; }
        .card-body strong { color: #b0b0b0; display: inline-block; min-width: 150px; }
        .timestamp { font-size: 0.8rem; color: #888; margin-top: 1rem; }
        .feedback-section { background-color: #383838; padding: 1rem 1.5rem; border-top: 1px solid #555; }
        .feedback-section strong { color: #ffffff; display: block; margin-bottom: 0.5rem; }
        .feedback-section p { margin: 0; line-height: 1.6; color: #d0d0d0; white-space: pre-wrap; }
        .student-feedback-section { background-color: #2a2a2a; padding: 1rem 1.5rem; border-top: 1px solid #555; }
        .student-feedback-section strong { color: #87ceeb; display: block; margin-bottom: 0.5rem; }
        .student-feedback-section p { margin: 0; line-height: 1.6; color: #d0d0d0; white-space: pre-wrap; }
        .empty-message { text-align: center; padding: 3rem; color: #888; font-size: 1.1rem; }
        .korean-translation { font-style: italic; color: #a0d8ef; }
        .criteria-info { margin: 0.8rem 0; }
        .criteria-info strong { color: #ffa500; }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }        

    </style>
</head>
<body>
    <header>
        <h1>실시간 제출 현황</h1>
        <div class="controls">
            <button id="btn-translation" class="active" onclick="switchView('translation')">번역 퀴즈 결과</button>
            <button id="btn-comprehension" onclick="switchView('comprehension')">이해력 퀴즈 결과</button>
            <button id="clear-btn" onclick="clearCurrentView()">화면 지우기</button>
            <button id="logout-btn" onclick="location.href='/teacher-logout'">로그아웃</button>
        </div>
    </header>

    <div id="translation-view" class="view-container active"></div>
    <div id="comprehension-view" class="view-container"></div>

    <script>
        let currentView = 'translation';
        let lastTranslationId = 0;        // ← 여기 추가!
        let lastComprehensionId = 0;      // ← 여기 추가!

        function switchView(viewType) {
            currentView = viewType;
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${viewType}`).classList.add('active');
            document.querySelectorAll('.view-container').forEach(container => container.classList.remove('active'));
            document.getElementById(`${viewType}-view`).classList.add('active');
            loadSubmissions(viewType);
        }

        function clearCurrentView() {
            const container = document.getElementById(`${currentView}-view`);
            container.innerHTML = '<p class="empty-message">화면이 초기화되었습니다.</p>';
            console.log(`${currentView} 뷰의 화면이 초기화되었습니다.`);
        }

        async function loadSubmissions(quizType, page = 1) {
            const container = document.getElementById(`${quizType}-view`);
            
            // 첫 로딩일 때만 "데이터를 불러오는 중..." 표시
            if (page === 1 && container.children.length === 0) {
                container.innerHTML = '<p class="empty-message">데이터를 불러오는 중...</p>';
            }
            
            try {
                const response = await fetch(`/api/get-submissions?quiz_type=${quizType}&page=${page}&class_name=all`);
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/teacher-login';
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    // ★★★ 현재 뷰의 마지막 ID 가져오기 ★★★
                    const lastId = quizType === 'translation' ? lastTranslationId : lastComprehensionId;
                    
                    // ★★★ 새로운 제출물만 필터링 ★★★
                    const newItems = data.items.filter(item => item.id > lastId);
                    
                    if (newItems.length > 0) {
                        // ★★★ "데이터를 불러오는 중..." 메시지 제거 (첫 로딩 시) ★★★
                        const emptyMessage = container.querySelector('.empty-message');
                        if (emptyMessage) {
                            container.innerHTML = '';
                        }
                        
                        // ★★★ 새 카드만 추가 (기존 카드는 유지) ★★★
                        newItems.reverse().forEach(item => {
                            const card = createSubmissionCard(item, quizType);
                            container.prepend(card);  // 맨 위에 추가
                        });
                        
                        // ★★★ 마지막 ID 업데이트 ★★★
                        const maxId = Math.max(...data.items.map(item => item.id));
                        if (quizType === 'translation') {
                            lastTranslationId = maxId;
                        } else {
                            lastComprehensionId = maxId;
                        }
                    }
                    
                    // ★★★ 페이지네이션 버튼 추가 (첫 로딩 시에만) ★★★
                    if (page === 1 && data.total_pages > 1) {
                        addPaginationButtons(container, quizType, data.current_page, data.total_pages);
                    }
                    
                } else {
                    if (container.children.length === 0) {
                        container.innerHTML = '<p class="empty-message">아직 제출된 결과가 없습니다.</p>';
                    }
                }
            } catch (error) {
                console.error(`${quizType} 제출물 로딩 오류:`, error);
                container.innerHTML = `<p class="empty-message" style="color: #e74c3c;">데이터를 불러오는 데 실패했습니다.</p>`;
            }
        }

        function addPaginationButtons(container, quizType, currentPage, totalPages) {
            // 기존 페이지네이션 버튼 제거 (중복 방지)
            const existingPagination = container.querySelector('.pagination-container');
            if (existingPagination) {
                existingPagination.remove();
            }

            // 페이지네이션 컨테이너 생성
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-container';
            paginationDiv.style.cssText = 'text-align: center; margin: 2rem 0; padding: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;';

            // 이전 페이지 버튼
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '←';
                prevBtn.style.cssText = 'padding: 0.5rem 1rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;';
                prevBtn.onmouseover = () => prevBtn.style.background = '#666';
                prevBtn.onmouseout = () => prevBtn.style.background = '#555';
                prevBtn.onclick = () => loadMoreSubmissions(quizType, currentPage - 1);
                paginationDiv.appendChild(prevBtn);
            }

            // ★★★ 페이지 번호 버튼들 생성 ★★★
            const maxVisiblePages = 10; // 한 번에 보여줄 최대 페이지 수
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // startPage 재조정 (끝쪽에서 10개가 안 보이는 경우)
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 첫 페이지로 가는 버튼 (startPage가 1이 아닐 때)
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.style.cssText = 'padding: 0.5rem 0.8rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;';
                firstBtn.onmouseover = () => firstBtn.style.background = '#666';
                firstBtn.onmouseout = () => firstBtn.style.background = '#555';
                firstBtn.onclick = () => loadMoreSubmissions(quizType, 1);
                paginationDiv.appendChild(firstBtn);

                // "..." 표시
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.cssText = 'color: #888; padding: 0 0.5rem;';
                paginationDiv.appendChild(dots);
            }

            // 페이지 번호 버튼들
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                
                // 현재 페이지는 크고 볼드 처리
                if (i === currentPage) {
                    pageBtn.style.cssText = 'padding: 0.6rem 1rem; background: #7289da; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.3rem; font-weight: bold;';
                } else {
                    pageBtn.style.cssText = 'padding: 0.5rem 0.8rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;';
                    pageBtn.onmouseover = () => pageBtn.style.background = '#666';
                    pageBtn.onmouseout = () => pageBtn.style.background = '#555';
                }
                
                pageBtn.onclick = () => loadMoreSubmissions(quizType, i);
                paginationDiv.appendChild(pageBtn);
            }

            // 마지막 페이지로 가는 버튼 (endPage가 totalPages가 아닐 때)
            if (endPage < totalPages) {
                // "..." 표시
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.cssText = 'color: #888; padding: 0 0.5rem;';
                paginationDiv.appendChild(dots);

                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.style.cssText = 'padding: 0.5rem 0.8rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;';
                lastBtn.onmouseover = () => lastBtn.style.background = '#666';
                lastBtn.onmouseout = () => lastBtn.style.background = '#555';
                lastBtn.onclick = () => loadMoreSubmissions(quizType, totalPages);
                paginationDiv.appendChild(lastBtn);
            }

            // 다음 페이지 버튼
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '→';
                nextBtn.style.cssText = 'padding: 0.5rem 1rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;';
                nextBtn.onmouseover = () => nextBtn.style.background = '#666';
                nextBtn.onmouseout = () => nextBtn.style.background = '#555';
                nextBtn.onclick = () => loadMoreSubmissions(quizType, currentPage + 1);
                paginationDiv.appendChild(nextBtn);
            }

            container.appendChild(paginationDiv);
        }

        function loadMoreSubmissions(quizType, page) {
            const container = document.getElementById(`${quizType}-view`);
            
            // ★★★ 기존 카드들을 모두 제거 (새 페이지 내용으로 교체) ★★★
            const cards = container.querySelectorAll('.submission-card');
            cards.forEach(card => card.remove());

            // 기존 페이지네이션 제거
            const existingPagination = container.querySelector('.pagination-container');
            if (existingPagination) {
                existingPagination.remove();
            }

            // 로딩 메시지 표시
            const loadingMsg = document.createElement('p');
            loadingMsg.className = 'empty-message';
            loadingMsg.textContent = '데이터를 불러오는 중...';
            container.appendChild(loadingMsg);

            fetch(`/api/get-submissions?quiz_type=${quizType}&page=${page}&class_name=all`)
                .then(response => response.json())
                .then(data => {
                    // 로딩 메시지 제거
                    loadingMsg.remove();

                    // 카드들을 추가
                    if (data.items && data.items.length > 0) {
                        data.items.reverse().forEach(item => {
                            const card = createSubmissionCard(item, quizType);
                            container.appendChild(card);
                        });

                        // 페이지네이션 버튼 재생성
                        if (data.total_pages > 1) {
                            addPaginationButtons(container, quizType, data.current_page, data.total_pages);
                        }
                    } else {
                        container.innerHTML = '<p class="empty-message">아직 제출된 결과가 없습니다.</p>';
                    }
                })
                .catch(error => {
                    console.error('페이지 로딩 오류:', error);
                    loadingMsg.textContent = '데이터를 불러오는 데 실패했습니다.';
                    loadingMsg.style.color = '#e74c3c';
                });
        }

        function createSubmissionCard(item, quizType) {
            const card = document.createElement('div');
            card.className = 'submission-card';

            const analysis = item.ai_analysis_json || {};
            let scoreValue, questionText, feedbackText;
            let cardBodyExtraHtml = '';
            let criteriaHtml = '';
            let studentFeedbackHtml = '';

            // 퀴즈 유형에 관계없이 공통으로 사용할 변수들
            const koreanTranslation = analysis.student_answer_korean_translation || '(번역 없음)';
            const vocabItalian = analysis.key_vocabularies_italian || [];
            const vocabKorean = analysis.key_vocabularies_korean_translation || [];
            
            let keywordsString = '';
            if (vocabItalian.length > 0) {
                keywordsString = vocabItalian.map((vocab, index) => 
                    `${vocab}(${vocabKorean[index] || '뜻 없음'})`
                ).join(', ');
            }

            const keywordsHtml = keywordsString 
                ? `<p><strong>핵심 어휘:</strong> ${keywordsString}</p>`
                : '';

            // 퀴즈 유형별로 다른 데이터 설정
            if (quizType === 'translation') {
                scoreValue = parseFloat(item.score);
                questionText = item.korean_sentence;
                feedbackText = analysis.evaluation_feedback || '(피드백 없음)';

                cardBodyExtraHtml = `
                    <p><strong>학생 답안 (번역):</strong> <span class="korean-translation">${koreanTranslation}</span></p>
                    ${keywordsHtml}
                `;

            } else { // comprehension
                scoreValue = parseFloat(analysis.score);
                questionText = item.korean_dialogue;
                feedbackText = analysis.evaluation || '(평가 없음)';

                // ★★★ [핵심 수정] key_points에서 목표 어휘와 문맥 문장 추출 ★★★
                const keyPoints = item.key_points || {};
                const targetVocabulary = keyPoints.target_vocabulary || [];
                const meaningPoints = keyPoints.meaning_points || [];

                const targetVocabString = targetVocabulary.length > 0 
                    ? targetVocabulary.join(', ') 
                    : '(목표 어휘 없음)';
                
                const meaningPointsString = meaningPoints.length > 0
                    ? meaningPoints.join(', ')
                    : '(문맥 문장 없음)';

                criteriaHtml = `
                    <div class="criteria-info">
                        <p><strong>목표 어휘:</strong> ${targetVocabString}</p>
                        <p><strong>문맥 문장:</strong> ${meaningPointsString}</p>
                    </div>
                `;

                cardBodyExtraHtml = `
                    <p><strong>학생 답안 (번역):</strong> <span class="korean-translation">${koreanTranslation}</span></p>
                    ${keywordsHtml}
                `;

                // ★★★ [핵심 수정] 학생 피드백을 이탈리아어 원문 그대로 표시 ★★★
                const studentFeedbackItalian = analysis.feedback || '(피드백 없음)';
                const studentFeedbackKorean = item.feedback_korean || '(번역 없음)';  // ← 현재는 NULL (번역 기능 제거됨)
                studentFeedbackHtml = `
                    <div class="student-feedback-section">
                        <strong>학생의 피드백:</strong>
                        <p>${studentFeedbackItalian}</p>
                        <strong style="margin-top: 1rem;">학생의 피드백 (번역):</strong>
                        <p>${studentFeedbackKorean}</p>
                    </div>
                `;
            }

            const scoreClass = scoreValue >= 7.0 ? 'high' : 'low';
            const scoreDisplay = isNaN(scoreValue) ? 'N/A' : scoreValue.toFixed(1);
            const formattedDate = new Date(item.created_at).toLocaleString('ko-KR');

            card.innerHTML = `
                <div class="card-main-content">
                    <div class="card-header">
                        <div class="student-info">
                            <span>학생 ID: <span class="id">${item.student_id}</span></span>
                            <span class="class-badge">${item.class_name || '반 없음'}</span>
                        </div>
                        <div class="score ${scoreClass}">${scoreDisplay}</div>
                    </div>
                    <div class="card-body">
                        <p><strong>원본:</strong> ${questionText}</p>
                        ${criteriaHtml}
                        <p><strong>학생 답안:</strong> <span class="korean-translation"> ${item.student_answer}</span></p>
                        ${cardBodyExtraHtml}
                    </div>
                    <div class="timestamp">${formattedDate}</div>
                </div>
                ${studentFeedbackHtml}
                <div class="feedback-section">
                    <strong>AI 평가 (교수용):</strong>
                    <p>${feedbackText}</p>
                </div>
            `;
            return card;
        }

        // 실시간 업데이트를 위한 폴링 함수
        function startAutoRefresh() {
            setInterval(() => {
                loadSubmissions(currentView);  // 현재 보고 있는 뷰만 자동 갱신
            }, 2000);  // 3초마다 갱신
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSubmissions('translation');
            startAutoRefresh();  // ★★★ 이 줄을 추가하세요! ★★★
        });
    </script>
</body>
</html>