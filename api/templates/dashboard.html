<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 1rem; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        h1 { color: #ffffff; margin: 0; }
        .controls { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center; }
        .controls button { color: white; border: 1px solid #555; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 1rem; background-color: #333; transition: background-color 0.2s, border-color 0.2s; }
        .controls button.active { background-color: #7289da; border-color: #7289da; font-weight: bold; }
        .controls button:hover:not(.active) { background-color: #444; }
        #clear-btn { background-color: #c0392b; border: 1px solid #c0392b; }
        #clear-btn:hover { background-color: #e74c3c; border-color: #e74c3c; }
        #logout-btn { background-color: #555; border: none; }
        #logout-btn:hover { background-color: #777; }
        
        .view-container { display: none; }
        .view-container.active { display: block; }
        
        .submission-card { background-color: #2c2c2c; 
            border: 1px solid #444; 
            border-radius: 8px; 
            margin-bottom: 1.5rem; 
            overflow: hidden; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        .card-main-content { padding: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 1rem; }
        .student-info { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 0.8rem; }
        .student-info .id { color: #87ceeb; }
        .class-badge { background-color: #4f545c; color: #e0e0e0; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.8rem; font-weight: normal; }
        .score { font-size: 2rem; font-weight: bold; }
        .score.high { color: #4CAF50; }
        .score.low { color: #F44336; }
        .card-body p { margin: 0.8rem 0; line-height: 1.6; }
        .card-body strong { color: #b0b0b0; display: inline-block; min-width: 150px; }
        .timestamp { font-size: 0.8rem; color: #888; margin-top: 1rem; }
        .feedback-section { background-color: #383838; padding: 1rem 1.5rem; border-top: 1px solid #555; }
        .feedback-section strong { color: #ffffff; display: block; margin-bottom: 0.5rem; }
        .feedback-section p { margin: 0; line-height: 1.6; color: #d0d0d0; }
        .student-feedback-section { background-color: #2a2a2a; padding: 1rem 1.5rem; border-top: 1px solid #555; }
        .student-feedback-section strong { color: #87ceeb; display: block; margin-bottom: 0.5rem; }
        .student-feedback-section p { margin: 0; line-height: 1.6; color: #d0d0d0; white-space: pre-wrap; }
        .empty-message { text-align: center; padding: 3rem; color: #888; font-size: 1.1rem; }
        .korean-translation { font-style: italic; color: #a0d8ef; }
        .criteria-info { margin: 0.8rem 0; }
        .criteria-info strong { color: #ffa500; }
        
        .audio-playback {
            width: 100%;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }     
        
        .rating-text {
            font-size: 1.1rem;
            font-weight: normal;
            margin-left: 0.5rem;
            opacity: 0.8;
            vertical-align: middle;
        }

        /* â˜…â˜…â˜… AI êµìˆ˜ìš© í‰ê°€ ê²°ê³¼ ìŠ¤íƒ€ì¼ (ì‹ ê·œ ì¶”ê°€) â˜…â˜…â˜… */
        .professor-analysis {
            font-size: 0.9rem;
        }
        .professor-analysis h4 {
            color: #87ceeb;
            margin-top: 1rem;
            margin-bottom: 0.8rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #444;
            font-size: 1.1rem;
        }
        .professor-analysis p {
            margin: 0.5rem 0;
            line-height: 1.5;
            color: #d0d0d0;
        }
        .professor-analysis p strong {
            color: #e0e0e0;
            display: inline; /* p íƒœê·¸ ì•ˆì˜ strongì€ blockì´ ì•„ë‹ˆë„ë¡ ì¬ì •ì˜ */
        }
        .analysis-details > div {
            background-color: #222;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 0.8rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .analysis-details > div > strong {
            display: block;
            margin-bottom: 8px;
            color: #ffa500; /* Orange for the sub-title */
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>ì‹¤ì‹œê°„ ì œì¶œ í˜„í™©</h1>
        <div class="controls">
            <button id="btn-translation" class="active" onclick="switchView('translation')">ë²ˆì—­ í€´ì¦ˆ ê²°ê³¼</button>
            <button id="btn-comprehension" onclick="switchView('comprehension')">ì´í•´ë ¥ í€´ì¦ˆ ê²°ê³¼</button>
            <button id="btn-speaking" onclick="switchView('speaking')">ë§í•˜ê¸° í€´ì¦ˆ ê²°ê³¼</button>
            <button id="clear-btn" onclick="clearCurrentView()">í™”ë©´ ì§€ìš°ê¸°</button>
            <button id="logout-btn" onclick="location.href='/teacher-logout'">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </header>

    <div id="translation-view" class="view-container active"></div>
    <div id="comprehension-view" class="view-container"></div>
    <div id="speaking-view" class="view-container"></div>

    <script>
        let currentView = 'translation';
        let lastTranslationId = 0;
        let lastComprehensionId = 0;
        let lastSpeakingId = 0;
        let currentTranslationPage = 1;
        let currentComprehensionPage = 1;
        let currentSpeakingPage = 1;
        let autoRefreshInterval = null;

        function switchView(viewType) {
            currentView = viewType;
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${viewType}`).classList.add('active');
            document.querySelectorAll('.view-container').forEach(container => container.classList.remove('active'));
            document.getElementById(`${viewType}-view`).classList.add('active');
            
            let currentPage = 1;
            if (viewType === 'translation') currentPage = currentTranslationPage;
            else if (viewType === 'comprehension') currentPage = currentComprehensionPage;
            else if (viewType === 'speaking') currentPage = currentSpeakingPage;
            
            loadSubmissions(viewType, currentPage, false);
        }

        function clearCurrentView() {
            const container = document.getElementById(`${currentView}-view`);
            container.innerHTML = '<p class="empty-message">í™”ë©´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
            
            if (currentView === 'translation') {
                currentTranslationPage = 1;
                lastTranslationId = 0;
            } else if (currentView === 'comprehension') {
                currentComprehensionPage = 1;
                lastComprehensionId = 0;
            } else if (currentView === 'speaking') {
                currentSpeakingPage = 1;
                lastSpeakingId = 0;
            }
            
            console.log(`${currentView} ë·°ì˜ í™”ë©´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        async function loadSubmissions(quizType, page = 1, isAutoRefresh = false) {
            const container = document.getElementById(`${quizType}-view`);
            
            if (!isAutoRefresh) {
                container.innerHTML = '<p class="empty-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            }
            
            try {
                const response = await fetch(`/api/get-submissions?quiz_type=${quizType}&page=${page}&class_name=all`);
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/teacher-login';
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    let lastId = 0;
                    if (quizType === 'translation') lastId = lastTranslationId;
                    else if (quizType === 'comprehension') lastId = lastComprehensionId;
                    else if (quizType === 'speaking') lastId = lastSpeakingId;
                    
                    const itemsToDisplay = isAutoRefresh 
                        ? data.items.filter(item => item.id > lastId)
                        : data.items;
                    
                    if (itemsToDisplay.length > 0) {
                        const emptyMessage = container.querySelector('.empty-message');
                        if (emptyMessage) {
                            container.innerHTML = '';
                        }
                        
                        itemsToDisplay.forEach(item => {
                            const card = createSubmissionCard(item, quizType);
                            if (isAutoRefresh) {
                                container.prepend(card);
                            } else {
                                container.appendChild(card);
                            }
                        });
                    }
                    
                    const maxId = Math.max(...data.items.map(item => item.id));
                    if (quizType === 'translation') {
                        lastTranslationId = Math.max(lastTranslationId, maxId);
                        if (!isAutoRefresh) currentTranslationPage = page;
                    } else if (quizType === 'comprehension') {
                        lastComprehensionId = Math.max(lastComprehensionId, maxId);
                        if (!isAutoRefresh) currentComprehensionPage = page;
                    } else if (quizType === 'speaking') {
                        lastSpeakingId = Math.max(lastSpeakingId, maxId);
                        if (!isAutoRefresh) currentSpeakingPage = page;
                    }
                    
                    if (!isAutoRefresh && data.total_pages > 1) {
                        addPaginationButtons(container, quizType, data.current_page, data.total_pages);
                    }
                    
                } else {
                    if (!isAutoRefresh && container.children.length === 0) {
                        container.innerHTML = '<p class="empty-message">ì•„ì§ ì œì¶œëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                }
            } catch (error) {
                console.error(`${quizType} ì œì¶œë¬¼ ë¡œë”© ì˜¤ë¥˜:`, error);
                if (!isAutoRefresh) {
                    container.innerHTML = `<p class="empty-message" style="color: #e74c3c;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                }
            }
        }

        function addPaginationButtons(container, quizType, currentPage, totalPages) {
            currentPage = parseInt(currentPage);
            totalPages = parseInt(totalPages);

            const existingPagination = container.querySelector('.pagination-container');
            if (existingPagination) {
                existingPagination.remove();
            }

            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-container';
            paginationDiv.style.cssText = 'text-align: center; margin: 2rem 0; padding: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;';

            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'â†';
                prevBtn.style.cssText = 'padding: 0.5rem 1rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;';
                prevBtn.onmouseover = () => prevBtn.style.background = '#666';
                prevBtn.onmouseout = () => prevBtn.style.background = '#555';
                prevBtn.onclick = () => loadSubmissions(quizType, currentPage - 1, false);
                paginationDiv.appendChild(prevBtn);
            }

            const maxVisiblePages = 10;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.style.cssText = 'padding: 0.5rem 0.8rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;';
                firstBtn.onmouseover = () => firstBtn.style.background = '#666';
                firstBtn.onmouseout = () => firstBtn.style.background = '#555';
                firstBtn.onclick = () => loadSubmissions(quizType, 1, false);
                paginationDiv.appendChild(firstBtn);

                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.cssText = 'color: #888; padding: 0 0.5rem;';
                paginationDiv.appendChild(dots);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                
                if (i === currentPage) {
                    pageBtn.style.cssText = `
                        padding: 0.7rem 1.1rem; 
                        background: #7289da; 
                        color: white; 
                        border: 2px solid white; 
                        border-radius: 4px; 
                        cursor: pointer; 
                        font-size: 1.4rem; 
                        font-weight: bold;
                        transform: scale(1.15);
                        box-shadow: 0 0 10px rgba(114, 137, 218, 0.5);
                    `;
                } else {
                    pageBtn.style.cssText = 'padding: 0.5rem 0.8rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;';
                    pageBtn.onmouseover = () => pageBtn.style.background = '#666';
                    pageBtn.onmouseout = () => pageBtn.style.background = '#555';
                }
                
                pageBtn.onclick = () => loadSubmissions(quizType, i, false);
                paginationDiv.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.cssText = 'color: #888; padding: 0 0.5rem;';
                paginationDiv.appendChild(dots);

                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.style.cssText = 'padding: 0.5rem 0.8rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;';
                lastBtn.onmouseover = () => lastBtn.style.background = '#666';
                lastBtn.onmouseout = () => lastBtn.style.background = '#555';
                lastBtn.onclick = () => loadSubmissions(quizType, totalPages, false);
                paginationDiv.appendChild(lastBtn);
            }

            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'â†’';
                nextBtn.style.cssText = 'padding: 0.5rem 1rem; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;';
                nextBtn.onmouseover = () => nextBtn.style.background = '#666';
                nextBtn.onmouseout = () => nextBtn.style.background = '#555';
                nextBtn.onclick = () => loadSubmissions(quizType, currentPage + 1, false);
                paginationDiv.appendChild(nextBtn);
            }

            container.appendChild(paginationDiv);
        }

        function getRatingDetails(score) {
            if (score >= 8.5) return { rating: 'Eccellente', color: '#2ecc71' }; // Vibrant Green
            if (score >= 7.0) return { rating: 'Buono', color: '#27ae60' };      // Green
            if (score >= 5.5) return { rating: 'Sufficiente', color: '#f1c40f' }; // Yellow
            if (score >= 4.0) return { rating: 'Da migliorare', color: '#e67e22' }; // Orange
            return { rating: 'Riprova', color: '#e74c3c' };                       // Red
        }

        // â˜…â˜…â˜… AI í‰ê°€ ê²°ê³¼ë¥¼ ê°€ë…ì„± ì¢‹ê²Œ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ì‹ ê·œ ì¶”ê°€) â˜…â˜…â˜…
        function formatAiAnalysisForProfessor(analysis) {
            if (!analysis || Object.keys(analysis).length === 0 || analysis.error) {
                return `<p style="color: #aaa;">AI ë¶„ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            const feedback = analysis.evaluation_feedback || {};
            
            // Helper: í…ìŠ¤íŠ¸ì˜ '\n'ì„ <br>ë¡œ ë³€í™˜
            const formatText = (text) => {
                return text ? String(text).replace(/\\n/g, '<br>') : '<span style="color: #888;">(ì •ë³´ ì—†ìŒ)</span>';
            };

            let html = '<div class="professor-analysis">';

            // ì ìˆ˜ ìš”ì•½
            html += `<h4>í‰ê°€ ì ìˆ˜ ìš”ì•½</h4>`;
            html += `<p><strong>ì •ë³´ í¬í•¨ë„ ì ìˆ˜:</strong> ${feedback.information_coverage_score !== undefined ? feedback.information_coverage_score : 'N/A'}</p>`;
            html += `<p><strong>ë¬¸ë²•/ì˜ë¯¸ ì •í™•ë„ ì ìˆ˜:</strong> ${feedback.semantic_accuracy_score !== undefined ? feedback.semantic_accuracy_score : 'N/A'}</p>`;
            html += `<p><strong>ì–´íœ˜ êµ¬ì‚¬ë ¥ ì ìˆ˜:</strong> ${feedback.vocabulary_coverage_score !== undefined ? feedback.vocabulary_coverage_score : 'N/A'}</p>`;

            // ì„¸ë¶€ ë¶„ì„
            html += `<h4>ì„¸ë¶€ ë¶„ì„</h4>`;
            html += `<div class="analysis-details">`;
            
            html += `<div><strong>ì •ë³´ í¬í•¨ë„:</strong><br>${formatText(feedback.information_coverage_details)}</div>`;
            html += `<div><strong>ë¬¸ë²•/ì˜ë¯¸ ì •í™•ë„:</strong><br>${formatText(feedback.semantic_accuracy_reason)}</div>`;
            html += `<div><strong>ì–´íœ˜ êµ¬ì‚¬ë ¥:</strong><br>${formatText(feedback.vocabulary_coverage_details)}</div>`;
            
            html += `</div>`;
            html += '</div>';

            return html;
        }

        function createSubmissionCard(item, quizType) {
            const card = document.createElement('div');
            card.className = 'submission-card';

            let analysis = {};
            try {
                if (typeof item.ai_analysis_json === 'string') {
                    analysis = JSON.parse(item.ai_analysis_json);
                } else if (typeof item.ai_analysis_json === 'object' && item.ai_analysis_json !== null) {
                    analysis = item.ai_analysis_json;
                }
            } catch (e) {
                console.error('AI analysis JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                analysis = { error: "AI ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
            }

            let scoreValue, questionText;
            let cardBodyExtraHtml = '';
            let criteriaHtml = '';
            let studentFeedbackHtml = '';

            const koreanTranslation = analysis.student_answer_korean_translation || '(ë²ˆì—­ ì—†ìŒ)';
            const vocabItalian = analysis.key_vocabularies_italian || [];
            const vocabKorean = analysis.key_vocabularies_korean_translation || [];
            
            let keywordsString = '';
            if (vocabItalian.length > 0) {
                keywordsString = vocabItalian.map((vocab, index) => 
                    `${vocab}(${vocabKorean[index] || 'ëœ» ì—†ìŒ'})`
                ).join(', ');
            }

            const keywordsHtml = keywordsString 
                ? `<p><strong>í•µì‹¬ ì–´íœ˜:</strong> ${keywordsString}</p>`
                : '';

            if (quizType === 'translation') {
                scoreValue = parseFloat(item.score);
                questionText = item.korean_sentence;

                cardBodyExtraHtml = `
                    <p><strong>í•™ìƒ ë‹µì•ˆ (ì›ë¬¸):</strong> ${item.student_answer || '(ë‹µì•ˆ ì—†ìŒ)'}</p>
                    <p><strong>í•™ìƒ ë‹µì•ˆ (AIë²ˆì—­):</strong> <span class="korean-translation">${koreanTranslation}</span></p>
                    ${keywordsHtml}
                `;

            } else if (quizType === 'comprehension') {
                scoreValue = parseFloat(analysis.score);
                questionText = item.korean_dialogue;

                const keyPoints = item.key_points || {};
                const targetVocabulary = keyPoints.target_vocabulary || [];
                const meaningPoints = keyPoints.meaning_points || [];

                const targetVocabString = targetVocabulary.length > 0 ? targetVocabulary.join(', ') : '(ëª©í‘œ ì–´íœ˜ ì—†ìŒ)';
                const meaningPointsString = meaningPoints.length > 0 ? meaningPoints.join(', ') : '(ë¬¸ë§¥ ë¬¸ì¥ ì—†ìŒ)';

                criteriaHtml = `
                    <div class="criteria-info">
                        <p><strong>ëª©í‘œ ì–´íœ˜:</strong> ${targetVocabString}</p>
                        <p><strong>ë¬¸ë§¥ ë¬¸ì¥:</strong> ${meaningPointsString}</p>
                    </div>
                `;
                cardBodyExtraHtml = `
                    <p><strong>í•™ìƒ ë‹µì•ˆ (ì›ë¬¸):</strong> ${item.student_answer || '(ë‹µì•ˆ ì—†ìŒ)'}</p>
                    <p><strong>í•™ìƒ ë‹µì•ˆ (AIë²ˆì—­):</strong> <span class="korean-translation">${koreanTranslation}</span></p>
                    ${keywordsHtml}
                `;
                const studentFeedbackItalian = analysis.feedback || '(í”¼ë“œë°± ì—†ìŒ)';
                const studentFeedbackKorean = item.feedback_korean || '(ë²ˆì—­ ì—†ìŒ)';
                studentFeedbackHtml = `
                    <div class="student-feedback-section">
                        <strong>í•™ìƒì—ê²Œ ë³´ë‚¸ í”¼ë“œë°±:</strong>
                        <p>${studentFeedbackItalian}</p>
                        <strong style="margin-top: 1rem;">í•™ìƒì—ê²Œ ë³´ë‚¸ í”¼ë“œë°± (ë²ˆì—­):</strong>
                        <p>${studentFeedbackKorean}</p>
                    </div>
                `;
            } else if (quizType === 'speaking') {
                scoreValue = parseFloat(analysis.score);
                questionText = item.situation_description || '(ìƒí™© ì—†ìŒ)';

                const requiredExpression = item.required_expression || '(í‘œí˜„ ì—†ìŒ)';
                const expectedAnswer = item.expected_korean_answer || '(ì˜ˆìƒ ë‹µë³€ ì—†ìŒ)';
                const recognizedText = item.recognized_korean_text || '(ì¸ì‹ ì‹¤íŒ¨)';
                const targetVocab = item.target_vocabulary || [];
                const vocabUsage = analysis.vocabulary_usage || {};
                
                const targetVocabString = targetVocab.length > 0 ? targetVocab.join(', ') : '(ëª©í‘œ ì–´íœ˜ ì—†ìŒ)';
                
                let vocabUsageHtml = '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">';
                for (const [vocab, info] of Object.entries(vocabUsage)) {
                    const usedIcon = info.used ? 'âœ…' : 'âŒ';
                    const note = info.note || '';
                    vocabUsageHtml += `<li>${usedIcon} <strong>${vocab}</strong>: ${note}</li>`;
                }
                vocabUsageHtml += '</ul>';
                
                criteriaHtml = `
                    <div class="criteria-info">
                        <p><strong>í‘œí˜„:</strong> ${requiredExpression}</p>
                        <p><strong>ì˜ˆìƒ ì •ë‹µ:</strong> ${expectedAnswer}</p>
                        <p><strong>ëª©í‘œ ì–´íœ˜:</strong> ${targetVocabString}</p>
                    </div>
                `;
                cardBodyExtraHtml = `
                    <p><strong>AI ì¸ì‹ í…ìŠ¤íŠ¸:</strong> <span class="korean-translation">${recognizedText}</span></p>
                    <p><strong>ì–´íœ˜ ì‚¬ìš© í˜„í™©:</strong></p>
                    ${vocabUsageHtml}
                    <p><strong>ğŸ”Š ìŒì„± íŒŒì¼:</strong></p>
                    <audio controls class="audio-playback">
                      <source src="${item.audio_file_url}" type="audio/mp4">
                      ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </audio>
                `;
                const studentFeedbackItalian = analysis.feedback || '(í”¼ë“œë°± ì—†ìŒ)';
                studentFeedbackHtml = `
                    <div class="student-feedback-section">
                        <strong>í•™ìƒì—ê²Œ ë³´ë‚¸ í”¼ë“œë°±:</strong>
                        <p>${studentFeedbackItalian}</p>
                    </div>
                `;
            }

            const ratingInfo = getRatingDetails(scoreValue);
            const scoreDisplay = isNaN(scoreValue) ? 'N/A' : scoreValue.toFixed(1);
            const formattedDate = new Date(item.created_at).toLocaleString('ko-KR');

            // â˜…â˜…â˜… AI í‰ê°€ JSONì„ êµ¬ì¡°í™”ëœ HTMLë¡œ ë³€í™˜ (ìˆ˜ì •) â˜…â˜…â˜…
            const professorAnalysisHtml = formatAiAnalysisForProfessor(analysis);

            card.innerHTML = `
                <div class="card-main-content">
                    <div class="card-header">
                        <div class="student-info">
                            <span>í•™ìƒ ID: <span class="id">${item.student_id}</span></span>
                            <span class="class-badge">${item.class_name || 'ë°˜ ì—†ìŒ'}</span>
                        </div>
                        <div class="score" style="color: ${ratingInfo.color};">${scoreDisplay}<span class="rating-text">${ratingInfo.rating}</span></div>
                    </div>
                    <div class="card-body">
                        <p><strong>ìƒí™©:</strong> ${questionText}</p>
                        ${criteriaHtml}
                        ${cardBodyExtraHtml}
                    </div>
                    <div class="timestamp">${formattedDate}</div>
                </div>
                ${studentFeedbackHtml}
                <div class="feedback-section">
                    <strong>AI í‰ê°€ (êµìˆ˜ìš©):</strong>
                    ${professorAnalysisHtml}
                </div>
            `;
            return card;
        }

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                let currentPage = 1;
                if (currentView === 'translation') currentPage = currentTranslationPage;
                else if (currentView === 'comprehension') currentPage = currentComprehensionPage;
                else if (currentView === 'speaking') currentPage = currentSpeakingPage;
                
                if (currentPage === 1) {
                    loadSubmissions(currentView, 1, true);
                }
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSubmissions('translation', 1, false);
            startAutoRefresh();
        });
    </script>
</body>
</html>