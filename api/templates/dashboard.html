<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 대시보드</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 1rem; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        h1 { color: #ffffff; margin: 0; }
        .controls { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center; }
        .controls button { color: white; border: 1px solid #555; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 1rem; background-color: #333; transition: background-color 0.2s, border-color 0.2s; }
        .controls button.active { background-color: #7289da; border-color: #7289da; font-weight: bold; }
        .controls button:hover:not(.active) { background-color: #444; }
        #clear-btn { background-color: #c0392b; border: 1px solid #c0392b; }
        #clear-btn:hover { background-color: #e74c3c; border-color: #e74c3c; }
        #logout-btn { background-color: #555; border: none; }
        #logout-btn:hover { background-color: #777; }
        
        .view-container { display: none; }
        .view-container.active { display: block; }
        
        .submission-card { background-color: #2c2c2c; border: 1px solid #444; border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden; }
        .card-main-content { padding: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 1rem; }
        .student-info { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 0.8rem; }
        .student-info .id { color: #87ceeb; }
        .class-badge { background-color: #4f545c; color: #e0e0e0; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.8rem; font-weight: normal; }
        .score { font-size: 2rem; font-weight: bold; }
        .score.high { color: #4CAF50; }
        .score.low { color: #F44336; }
        .card-body p { margin: 0.8rem 0; line-height: 1.6; }
        .card-body strong { color: #b0b0b0; display: inline-block; min-width: 150px; }
        .timestamp { font-size: 0.8rem; color: #888; margin-top: 1rem; }
        .feedback-section { background-color: #383838; padding: 1rem 1.5rem; border-top: 1px solid #555; }
        .feedback-section strong { color: #ffffff; display: block; margin-bottom: 0.5rem; }
        .feedback-section p { margin: 0; line-height: 1.6; color: #d0d0d0; white-space: pre-wrap; }
        /* ★★★ [추가] 학생 피드백 섹션 스타일 ★★★ */
        .student-feedback-section { background-color: #2a2a2a; padding: 1rem 1.5rem; border-top: 1px solid #555; }
        .student-feedback-section strong { color: #87ceeb; display: block; margin-bottom: 0.5rem; }
        .student-feedback-section p { margin: 0; line-height: 1.6; color: #d0d0d0; white-space: pre-wrap; }
        .empty-message { text-align: center; padding: 3rem; color: #888; font-size: 1.1rem; }
        .korean-translation { font-style: italic; color: #a0d8ef; }
        /* ★★★ [추가] 목표 어휘 및 문맥 문장 스타일 ★★★ */
        .criteria-info { background-color: #252525; padding: 0.8rem; border-radius: 6px; margin: 0.8rem 0; }
        .criteria-info strong { color: #ffa500; }
    </style>
</head>
<body>
    <header>
        <h1>실시간 제출 현황</h1>
        <div class="controls">
            <button id="btn-translation" class="active" onclick="switchView('translation')">번역 퀴즈 결과</button>
            <button id="btn-comprehension" onclick="switchView('comprehension')">이해력 퀴즈 결과</button>
            <button id="clear-btn" onclick="clearCurrentView()">화면 지우기</button>
            <button id="logout-btn" onclick="location.href='/teacher-logout'">로그아웃</button>
        </div>
    </header>

    <div id="translation-view" class="view-container active"></div>
    <div id="comprehension-view" class="view-container"></div>

    <script>
        let currentView = 'translation';

        function switchView(viewType) {
            currentView = viewType;
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${viewType}`).classList.add('active');
            document.querySelectorAll('.view-container').forEach(container => container.classList.remove('active'));
            document.getElementById(`${viewType}-view`).classList.add('active');
            loadSubmissions(viewType);
        }

        function clearCurrentView() {
            const container = document.getElementById(`${currentView}-view`);
            container.innerHTML = '<p class="empty-message">화면이 초기화되었습니다.</p>';
            console.log(`${currentView} 뷰의 화면이 초기화되었습니다.`);
        }

        async function loadSubmissions(quizType) {
            const container = document.getElementById(`${quizType}-view`);
            container.innerHTML = '<p class="empty-message">데이터를 불러오는 중...</p>';
            
            try {
                const response = await fetch(`/api/get-${quizType}-submissions`);
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/teacher-login';
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }
                
                const data = await response.json();
                container.innerHTML = '';

                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const card = createSubmissionCard(item, quizType);
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="empty-message">아직 제출된 결과가 없습니다.</p>';
                }
            } catch (error) {
                console.error(`${quizType} 제출물 로딩 오류:`, error);
                container.innerHTML = `<p class="empty-message" style="color: #e74c3c;">데이터를 불러오는 데 실패했습니다.</p>`;
            }
        }

        // ★★★ [핵심 수정] 이해력 퀴즈용 추가 정보 표시 로직 ★★★
        async function translateToKorean(italianText) {
            // 간단한 번역 함수 (실제로는 백엔드 API를 통해 번역하는 것이 좋지만, 
            // 여기서는 프론트엔드에서 Gemini API를 직접 호출하지 않으므로
            // 대신 표시만 하도록 처리합니다. 실제 번역은 백엔드에서 해야 합니다.)
            // 현재는 이탈리아어 원문을 그대로 표시하되, 
            // 교수님께서 한국어 번역을 원하시면 백엔드 수정이 필요합니다.
            return `(번역: ${italianText})`; // 임시 처리
        }

        function createSubmissionCard(item, quizType) {
            const card = document.createElement('div');
            card.className = 'submission-card';

            const analysis = item.ai_analysis_json || {};
            let scoreValue, questionText, feedbackText;
            let cardBodyExtraHtml = '';
            let criteriaHtml = ''; // 이해력 퀴즈용 추가 정보
            let studentFeedbackHtml = ''; // 학생 피드백 섹션

            // 퀴즈 유형에 관계없이 공통으로 사용할 변수들
            const koreanTranslation = analysis.student_answer_korean_translation || '(번역 없음)';
            const vocabItalian = analysis.key_vocabularies_italian || [];
            const vocabKorean = analysis.key_vocabularies_korean_translation || [];
            
            let keywordsString = '';
            if (vocabItalian.length > 0) {
                keywordsString = vocabItalian.map((vocab, index) => 
                    `${vocab}(${vocabKorean[index] || '뜻 없음'})`
                ).join(', ');
            }

            const keywordsHtml = keywordsString 
                ? `<p><strong>핵심 어휘:</strong> ${keywordsString}</p>`
                : '';

            // 퀴즈 유형별로 다른 데이터 설정
            if (quizType === 'translation') {
                scoreValue = parseFloat(item.score);
                questionText = item.korean_sentence;
                feedbackText = analysis.evaluation_feedback || '(피드백 없음)';

                cardBodyExtraHtml = `
                    <p><strong>학생 답안 (번역):</strong> <span class="korean-translation">${koreanTranslation}</span></p>
                    ${keywordsHtml}
                `;

            } else { // comprehension
                scoreValue = parseFloat(analysis.score);
                questionText = item.korean_dialogue;
                feedbackText = analysis.evaluation || '(평가 없음)';

                // ★★★ [핵심 추가] 이해력 퀴즈의 경우, key_points에서 추가 정보 추출 ★★★
                // 백엔드 API에서 key_points를 함께 반환해야 합니다.
                // 현재는 item에서 직접 가져올 수 없으므로, 
                // 백엔드 수정이 필요합니다. 임시로 analysis에서 시도합니다.
                
                // 교수님, 이 부분은 백엔드에서 key_points를 함께 전달해야 표시할 수 있습니다.
                // 현재는 임시로 빈 값으로 처리합니다.
                const targetVocabulary = '(백엔드에서 key_points 전달 필요)';
                const meaningPoints = '(백엔드에서 key_points 전달 필요)';

                criteriaHtml = `
                    <div class="criteria-info">
                        <p><strong>목표 어휘:</strong> ${targetVocabulary}</p>
                        <p><strong>문맥 문장:</strong> ${meaningPoints}</p>
                    </div>
                `;

                cardBodyExtraHtml = `
                    <p><strong>학생 답안 (번역):</strong> <span class="korean-translation">${koreanTranslation}</span></p>
                    ${keywordsHtml}
                `;

                // ★★★ [핵심 추가] 학생 피드백을 한국어로 번역하여 표시 ★★★
                const studentFeedbackItalian = analysis.feedback || '(피드백 없음)';
                // 실제 번역은 백엔드에서 해야 하므로, 여기서는 표시만 합니다.
                studentFeedbackHtml = `
                    <div class="student-feedback-section">
                        <strong>학생 피드백 (한국어 번역):</strong>
                        <p>${studentFeedbackItalian}</p>
                        <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">(※ 이탈리아어 원문의 한국어 번역은 백엔드에서 처리 필요)</p>
                    </div>
                `;
            }

            const scoreClass = scoreValue >= 7.0 ? 'high' : 'low';
            const scoreDisplay = isNaN(scoreValue) ? 'N/A' : scoreValue.toFixed(1);
            const formattedDate = new Date(item.created_at).toLocaleString('ko-KR');

            card.innerHTML = `
                <div class="card-main-content">
                    <div class="card-header">
                        <div class="student-info">
                            <span>학생 ID: <span class="id">${item.student_id}</span></span>
                            <span class="class-badge">${item.class_name || '반 없음'}</span>
                        </div>
                        <div class="score ${scoreClass}">${scoreDisplay}</div>
                    </div>
                    <div class="card-body">
                        <p><strong>원본:</strong> ${questionText}</p>
                        ${criteriaHtml}
                        <p><strong>학생 답안:</strong> ${item.student_answer}</p>
                        ${cardBodyExtraHtml}
                    </div>
                    <div class="timestamp">${formattedDate}</div>
                </div>
                ${studentFeedbackHtml}
                <div class="feedback-section">
                    <strong>AI 평가 (교수용):</strong>
                    <p>${feedbackText}</p>
                </div>
            `;
            return card;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSubmissions('translation');
        });
    </script>
</body>
</html>