<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KR-Quiz 실시간 대시보드</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #1e2124; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 20px auto; padding: 30px; background-color: #282c34; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); }
        h1 { color: #ffffff; text-align: center; margin-bottom: 20px; }
        .logout-link { position: absolute; top: 20px; right: 20px; color: #7289da; text-decoration: none; }
        
        /* ★★★ 신규: 반 필터 버튼 스타일 ★★★ */
        .class-filter { text-align: center; margin-bottom: 30px; }
        .filter-btn { background-color: #40444b; color: #e0e0e0; border: 1px solid #4f545c; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; margin: 0 5px; transition: background-color 0.3s; }
        .filter-btn:hover { background-color: #4f545c; }
        .filter-btn.active { background-color: #7289da; color: white; border-color: #7289da; }

        #submissions-list { list-style-type: none; padding: 0; }
        .submission-item { background-color: #2f3136; border: 1px solid #40444b; padding: 20px; margin-bottom: 15px; border-radius: 8px; }
        .submission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .student-info { font-size: 1.2em; font-weight: bold; }
        .score { font-size: 1.4em; font-weight: bold; }
        .score-high { color: #2ecc71; } /* 7.0 이상 */
        .score-low { color: #e74c3c; } /* 6.9 이하 */
        .submission-body { background-color: #36393f; padding: 15px; border-radius: 5px; margin-top: 10px; }
        .ai-analysis { white-space: pre-wrap; font-family: "SF Mono", "Consolas", monospace; font-size: 0.9em; line-height: 1.6; }
        .timestamp { font-size: 0.8em; color: #99aab5; text-align: right; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>실시간 제출 현황</h1>
        <a href="/teacher-logout" class="logout-link">로그아웃</a>

        <!-- ★★★ 신규: 반 필터 버튼 UI ★★★ -->
        <div class="class-filter">
            <button class="filter-btn active" data-class="all">전체 보기</button>
            <button class="filter-btn" data-class="siena-3">3학년</button>
            <button class="filter-btn" data-class="master-1">석사 1학년</button>
            <button class="filter-btn" data-class="master-2">석사 2학년</button>
            <!-- 새로운 반이 추가되면 여기에 버튼만 추가하면 됩니다 -->
        </div>

        <ul id="submissions-list"></ul>
    </div>

    <script>
        let lastId = 0;
        // ★★★ 변경: 현재 선택된 필터를 추적하는 변수 추가 ★★★
        let currentClassFilter = 'all'; 

        function getScoreClass(score) {
            const s = parseFloat(score);
            if (isNaN(s)) return '';
            return s >= 7.0 ? 'score-high' : 'score-low';
        }

        function createSubmissionElement(item) {
            const li = document.createElement('li');
            li.className = 'submission-item';
            li.id = `submission-${item.id}`;

            const scoreClass = getScoreClass(item.score);
            const analysis = item.ai_analysis_json || {};
            
            // ★★★ 변경: 반 이름(class_name) 표시 추가 ★★★
            const classNameDisplay = item.class_name ? `(${item.class_name})` : '';

            li.innerHTML = `
                <div class="submission-header">
                    <span class="student-info">${item.student_id} ${classNameDisplay}</span>
                    <span class="score ${scoreClass}">${parseFloat(item.score).toFixed(1)}</span>
                </div>
                <div class="submission-body">
                    <p><strong>원본 질문:</strong> ${item.korean_sentence}</p>
                    <p><strong>학생 답안:</strong> ${item.student_answer}</p>
                    <details>
                        <summary>AI 상세 분석 보기</summary>
                        <pre class="ai-analysis">${JSON.stringify(analysis, null, 2)}</pre>
                    </details>
                </div>
                <div class="timestamp">${new Date(item.created_at).toLocaleString('ko-KR')}</div>
            `;
            return li;
        }

        async function fetchSubmissions() {
            try {
                // ★★★ 변경: API 요청 시 현재 선택된 반 필터 정보를 함께 보냅니다 ★★★
                const url = `/api/submissions?since_id=${lastId}&class_name=${currentClassFilter}`;
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/teacher-login';
                    throw new Error('서버 응답 오류');
                }
                const data = await response.json();
                const list = document.getElementById('submissions-list');

                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const newElement = createSubmissionElement(item);
                        list.prepend(newElement);
                    });
                    lastId = data.items[data.items.length - 1].id;
                }
            } catch (error) {
                console.error('제출물 로딩 오류:', error);
            }
        }
        
        // ★★★ 신규: 필터 버튼 클릭 이벤트 처리 로직 ★★★
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                // 모든 버튼에서 'active' 클래스 제거
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                // 클릭된 버튼에 'active' 클래스 추가
                this.classList.add('active');
                
                // 현재 필터 상태 업데이트
                currentClassFilter = this.dataset.class;
                
                // 목록 초기화 및 재로딩
                document.getElementById('submissions-list').innerHTML = '';
                lastId = 0;
                fetchSubmissions(); // 즉시 새로운 필터로 데이터 로드
            });
        });

        // 페이지 로드 시 및 3초마다 주기적으로 데이터 가져오기
        fetchSubmissions();
        setInterval(fetchSubmissions, 3000);
    </script>
</body>
</html>