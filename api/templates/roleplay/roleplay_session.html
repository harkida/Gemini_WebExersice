<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“‹ ì„¸ì…˜ ê´€ë¦¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: #0f1117; color: #e0e0e0; min-height: 100vh; font-size: 15px; }

        .header {
            background: linear-gradient(135deg, #1a1d2e 0%, #0f1117 100%);
            border-bottom: 1px solid #2a2d3e; padding: 18px 28px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header h1 { font-size: 22px; font-weight: 700; color: #fff; }
        .header h1 span { color: #f0a500; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions a {
            color: #888; text-decoration: none; font-size: 14px;
            padding: 8px 16px; border: 1px solid #333; border-radius: 6px; transition: all 0.2s;
        }
        .header-actions a:hover { color: #fff; border-color: #555; }

        .main { padding: 28px; max-width: 1200px; margin: 0 auto; }

        /* â”€â”€ ì¹´ë“œ â”€â”€ */
        .card { background: #1a1d2e; border: 1px solid #2a2d3e; border-radius: 10px; padding: 22px; margin-bottom: 18px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .card-title { font-size: 18px; font-weight: 700; color: #fff; }

        /* â”€â”€ í¼ â”€â”€ */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-row.triple { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 13px; color: #888; font-weight: 500; }
        .form-group input, .form-group select {
            background: #0f1117; border: 1px solid #2a2d3e; border-radius: 6px;
            padding: 10px 14px; color: #e0e0e0; font-size: 15px; font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #f0a500; }

        /* ì‹œë‚˜ë¦¬ì˜¤ ì²´í¬ë°•ìŠ¤ */
        .scenario-checklist { display: flex; flex-direction: column; gap: 8px; margin-top: 4px; }
        .scenario-checklist label {
            display: flex; align-items: center; gap: 8px; font-size: 15px; color: #ccc;
            cursor: pointer; padding: 8px 12px; border: 1px solid #2a2d3e; border-radius: 6px;
            transition: background 0.15s;
        }
        .scenario-checklist label:hover { background: #1f2233; }
        .scenario-checklist input[type="checkbox"] { accent-color: #f0a500; width: 18px; height: 18px; }

        /* â”€â”€ ë²„íŠ¼ â”€â”€ */
        .btn { padding: 9px 22px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-primary { background: #f0a500; color: #000; }
        .btn-primary:hover { background: #d99400; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #dc3545; color: #fff; }
        .btn-warning:hover { background: #c82333; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #c82333; }
        .btn-ghost { background: none; border: 1px solid #333; color: #888; }
        .btn-ghost:hover { border-color: #555; color: #ccc; }
        .btn-sm { padding: 5px 12px; font-size: 13px; }
        .btn-row { display: flex; gap: 8px; margin-top: 18px; }

        /* â”€â”€ ìƒíƒœ ë°°ì§€ â”€â”€ */
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .status-waiting { background: #2d2a1f; color: #ffd43b; }
        .status-active { background: #1f2d1f; color: #69db7c; }
        .status-completed { background: #2d1f2d; color: #b197fc; }

        /* â”€â”€ ì„¸ì…˜ ì¹´ë“œ â”€â”€ */
        .session-card { background: #1a1d2e; border: 1px solid #2a2d3e; border-radius: 10px; padding: 20px; margin-bottom: 14px; }
        .session-meta { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
        .session-meta .item { font-size: 14px; color: #999; }
        .session-meta .item strong { color: #ccc; }
        .session-scenarios { font-size: 14px; color: #888; margin-bottom: 12px; }
        .session-scenarios span { color: #f0a500; }

        /* â”€â”€ íŒ€ ê·¸ë¦¬ë“œ â”€â”€ */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 12px; }
        .team-badge {
            background: #0f1117; border: 1px solid #2a2d3e; border-radius: 8px;
            padding: 12px; text-align: center;
        }
        .team-badge .code { font-size: 20px; font-weight: 700; color: #f0a500; }
        .team-badge .count { font-size: 13px; color: #666; margin-top: 4px; }

        /* â”€â”€ ìƒíƒœ ë©”ì‹œì§€ â”€â”€ */
        .status-msg { padding: 12px 18px; border-radius: 6px; margin-bottom: 18px; font-size: 14px; display: none; }
        .status-msg.success { display: block; background: #1a2e1a; color: #69db7c; border: 1px solid #2d4a2d; }
        .status-msg.error { display: block; background: #2e1a1a; color: #ff6b6b; border: 1px solid #4a2d2d; }
        .empty-state { text-align: center; padding: 40px; color: #555; font-size: 15px; }

        /* â”€â”€ ê´€ì°° ëª¨ë‹¬ â”€â”€ */
        .observe-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;
        }
        .observe-overlay.open { display: flex; }
        .observe-modal {
            background: #1a1d2e; border: 1px solid #2a2d3e; border-radius: 12px;
            width: 90%; max-width: 600px; height: 80vh; display: flex; flex-direction: column;
        }
        .observe-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2d3e;
            display: flex; justify-content: space-between; align-items: center;
        }
        .observe-header h3 { margin: 0; color: #f0a500; font-size: 16px; }
        .observe-header .close-btn {
            background: none; border: 1px solid #555; color: #999; padding: 4px 12px;
            border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .observe-header .close-btn:hover { color: #fff; border-color: #999; }
        .observe-members { padding: 8px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #2a2d3e; }
        .observe-scenario-tabs {
            padding: 8px 20px; display: flex; gap: 8px; border-bottom: 1px solid #2a2d3e;
        }
        .observe-scenario-tabs button {
            background: #0f1117; border: 1px solid #2a2d3e; color: #888; padding: 4px 12px;
            border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .observe-scenario-tabs button.active { border-color: #f0a500; color: #f0a500; }
        .observe-chat {
            flex: 1; overflow-y: auto; padding: 16px 20px; display: flex;
            flex-direction: column; gap: 10px;
        }
        .ob-msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
        .ob-msg.player { align-self: flex-end; background: #7289da; color: #fff; border-bottom-right-radius: 4px; }
        .ob-msg.npc { align-self: flex-start; background: #2b2d31; border: 1px solid #3a3c41; color: #e0e0e0; border-bottom-left-radius: 4px; }
        .ob-msg.system { align-self: center; background: #f0a50015; color: #f0a500; font-size: 13px; border-radius: 8px; }
        .ob-msg .ob-label { font-size: 11px; color: #999; margin-bottom: 3px; }
        .ob-msg .ob-meta { font-size: 11px; color: #666; margin-top: 4px; text-align: right; }
        .observe-status { padding: 10px 20px; border-top: 1px solid #2a2d3e; font-size: 13px; color: #666; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ“‹ <span>ì„¸ì…˜</span> ê´€ë¦¬</h1>
    <div class="header-actions">
        <a href="/roleplay-admin">ğŸ­ ì½˜í…ì¸  ê´€ë¦¬</a>
        <a href="/dashboard">â† êµì‚¬ ëŒ€ì‹œë³´ë“œ</a>
    </div>
</div>

<div class="main">
    <div id="session-status" class="status-msg"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• ì„¸ì…˜ ìƒì„± í¼ â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="card" style="border-color: #f0a50040;">
        <div class="card-header"><div class="card-title">â• ìƒˆ ì„¸ì…˜ ë§Œë“¤ê¸°</div></div>

        <div class="form-row triple">
            <div class="form-group">
                <label>ë°˜ (Class) *</label>
                <select id="ss-class">
                    <option value="">-- ì„ íƒ --</option>
                    <option value="siena-3">3í•™ë…„ (Triennale 3)</option>
                    <option value="siena-master-1">ì„ì‚¬1 (Magistrale 1)</option>
                    <option value="siena-master-2">ì„ì‚¬2 (Magistrale 2)</option>
                </select>
            </div>
            <div class="form-group">
                <label>í•™ìŠµ ëª©í‘œ</label>
                <select id="ss-goal"><option value="">-- ëª©í‘œ ì„ íƒ (ì„ íƒì‚¬í•­) --</option></select>
            </div>
            <div class="form-group">
                <label>íŒ€ ìˆ˜ *</label>
                <input type="number" id="ss-teams" value="6" min="1" max="20">
            </div>
        </div>

        <div class="form-group">
            <label>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ * (ë³µìˆ˜ ê°€ëŠ¥)</label>
            <div class="scenario-checklist" id="ss-scenarios">
                <span style="color:#555;">ë¡œë”© ì¤‘...</span>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="createSession()">ì„¸ì…˜ ìƒì„±</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• ì„¸ì…˜ ëª©ë¡ â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="session-list"><div class="empty-state">ë¡œë”© ì¤‘...</div></div>
</div>

<script>
function showStatus(msg, type) {
    const el = document.getElementById('session-status');
    el.textContent = msg; el.className = `status-msg ${type}`;
    setTimeout(() => { el.className = 'status-msg'; }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â• ë“œë¡­ë‹¤ìš´/ì²´í¬ë°•ìŠ¤ ë¡œë“œ â•â•â•â•â•â•â•â•â•â•â•
async function loadFormData() {
    try {
        // ëª©í‘œ ë“œë¡­ë‹¤ìš´
        const goalRes = await fetch('/api/rp-admin/goals');
        const goalData = await goalRes.json();
        const goalSel = document.getElementById('ss-goal');
        if (goalData.goals) {
            for (const g of goalData.goals) {
                goalSel.innerHTML += `<option value="${g.id}">${g.title} (${g.class_name || ''})</option>`;
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì²´í¬ë°•ìŠ¤
        const scRes = await fetch('/api/rp-admin/scenarios');
        const scData = await scRes.json();
        const container = document.getElementById('ss-scenarios');
        container.innerHTML = '';
        if (scData.scenarios?.length) {
            for (const s of scData.scenarios) {
                container.innerHTML += `
                    <label>
                        <input type="checkbox" value="${s.id}">
                        ${s.title} â€” ${s.npc_name || '?'} (${s.npc_job || '?'})
                    </label>`;
            }
        } else {
            container.innerHTML = '<span style="color:#ff6b6b;">ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì½˜í…ì¸  ê´€ë¦¬ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</span>';
        }
    } catch (e) { console.error('í¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â• ì„¸ì…˜ ìƒì„± â•â•â•â•â•â•â•â•â•â•â•
async function createSession() {
    const className = document.getElementById('ss-class').value;
    const goalId = document.getElementById('ss-goal').value;
    const teamCount = parseInt(document.getElementById('ss-teams').value) || 1;

    const checked = document.querySelectorAll('#ss-scenarios input[type="checkbox"]:checked');
    const scenarioIds = Array.from(checked).map(c => parseInt(c.value));

    if (!className) { showStatus('âŒ ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.', 'error'); return; }
    if (scenarioIds.length === 0) { showStatus('âŒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.', 'error'); return; }

    try {
        const res = await fetch('/api/rp-admin/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                class_name: className,
                goal_id: goalId ? parseInt(goalId) : null,
                scenario_ids: scenarioIds,
                team_count: teamCount
            })
        });
        const data = await res.json();
        if (data.success) {
            showStatus(`âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ! (ID: ${data.id}, íŒ€ ${data.team_count}ê°œ)`, 'success');
            loadSessions();
        } else {
            showStatus(`âŒ ${data.error}`, 'error');
        }
    } catch (e) { showStatus(`âŒ ${e.message}`, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â• ì„¸ì…˜ ëª©ë¡ â•â•â•â•â•â•â•â•â•â•â•
async function loadSessions() {
    try {
        const res = await fetch('/api/rp-admin/sessions');
        const data = await res.json();

        if (!data.sessions?.length) {
            document.getElementById('session-list').innerHTML = '<div class="empty-state">ì•„ì§ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ìƒì„±í•˜ì„¸ìš”.</div>';
            return;
        }

        let html = '';
        for (const s of data.sessions) {
            const statusClass = `status-${s.status}`;
            const statusLabel = { waiting: 'â³ ëŒ€ê¸° ì¤‘', active: 'ğŸŸ¢ ì§„í–‰ ì¤‘', completed: 'âœ… ì™„ë£Œ' }[s.status] || s.status;
            const scenarioNames = s.scenarios?.map(sc => sc.title).join(', ') || '-';
            const createdAt = new Date(s.created_at).toLocaleString('ko-KR');

            // ì•¡ì…˜ ë²„íŠ¼
            let actions = '';
            if (s.status === 'waiting') {
                actions = `
                    <button class="btn btn-success btn-sm" onclick="startSession(${s.id})">â–¶ ì‹œì‘</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSession(${s.id})">ì‚­ì œ</button>`;
            } else if (s.status === 'active') {
                actions = `<button class="btn btn-warning btn-sm" onclick="completeSession(${s.id})">â¹ ì¢…ë£Œ</button>`;
            } else {
                actions = `<button class="btn btn-danger btn-sm" onclick="deleteSession(${s.id})">ì‚­ì œ</button>`;
            }

            // íŒ€ ë°°ì§€
            let teamHtml = '';
            if (s.teams?.length) {
                teamHtml = '<div class="team-grid">';
                for (const t of s.teams) {
                    teamHtml += `
                        <div class="team-badge" style="cursor:pointer;" onclick="openObserve(${s.id}, ${t.id}, '${t.team_code}')">
                            <div class="code">${t.team_code}</div>
                            <div class="count">${t.member_count}ëª…</div>
                        </div>`;
                }
                teamHtml += '</div>';
            }
            
            html += `
            <div class="session-card">
                <div class="card-header">
                    <div>
                        <span class="card-title">ì„¸ì…˜ #${s.id}</span>
                        <span class="status ${statusClass}" style="margin-left:12px;">${statusLabel}</span>
                    </div>
                    <div style="display:flex; gap:6px;">${actions}</div>
                </div>
                <div class="session-meta">
                    <div class="item"><strong>ë°˜:</strong> ${s.class_name}</div>
                    <div class="item"><strong>ëª©í‘œ:</strong> ${s.goal_title || '-'}</div>
                    <div class="item"><strong>ìƒì„±:</strong> ${createdAt}</div>
                </div>
                <div class="session-scenarios">ì‹œë‚˜ë¦¬ì˜¤: <span>${scenarioNames}</span></div>
                ${teamHtml}
            </div>`;
        }
        document.getElementById('session-list').innerHTML = html;
    } catch (e) {
        document.getElementById('session-list').innerHTML = `<div class="empty-state" style="color:#ff6b6b;">${e.message}</div>`;
    }
}

// â•â•â•â•â•â•â•â•â•â•â• ì„¸ì…˜ ìƒíƒœ ë³€ê²½ â•â•â•â•â•â•â•â•â•â•â•
async function startSession(id) {
    if (!confirm(`ì„¸ì…˜ #${id}ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    try {
        const res = await fetch(`/api/rp-admin/sessions/${id}/start`, { method: 'PUT' });
        const data = await res.json();
        if (data.success) { showStatus('âœ… ì„¸ì…˜ ì‹œì‘!', 'success'); loadSessions(); }
        else showStatus(`âŒ ${data.error}`, 'error');
    } catch (e) { showStatus(`âŒ ${e.message}`, 'error'); }
}

async function completeSession(id) {
    if (!confirm(`ì„¸ì…˜ #${id}ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•™ìƒë“¤ì€ ë” ì´ìƒ ëŒ€í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
    try {
        const res = await fetch(`/api/rp-admin/sessions/${id}/complete`, { method: 'PUT' });
        if ((await res.json()).success) { showStatus('âœ… ì„¸ì…˜ ì¢…ë£Œ', 'success'); loadSessions(); }
    } catch (e) { showStatus(`âŒ ${e.message}`, 'error'); }
}

async function deleteSession(id) {
    if (!confirm(`ì„¸ì…˜ #${id}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níŒ€, ë©¤ë²„ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    try {
        const res = await fetch(`/api/rp-admin/sessions/${id}`, { method: 'DELETE' });
        if ((await res.json()).success) { showStatus('âœ… ì‚­ì œ ì™„ë£Œ', 'success'); loadSessions(); }
    } catch (e) { showStatus(`âŒ ${e.message}`, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â• ì´ˆê¸° ë¡œë“œ + ì¡°ê±´ë¶€ í´ë§ â•â•â•â•â•â•â•â•â•â•â•
let sessionPolling = null;

function startSessionPolling() {
    stopSessionPolling();
    sessionPolling = setInterval(loadSessions, 3000);
}
function stopSessionPolling() {
    if (sessionPolling) { clearInterval(sessionPolling); sessionPolling = null; }
}

// íƒ­ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ í´ë§ ì¤‘ì§€, ëŒì•„ì˜¤ë©´ ì¬ê°œ
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopSessionPolling();
    } else {
        loadSessions();
        startSessionPolling();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    loadFormData();
    loadSessions();
    startSessionPolling();
});

// í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
window.addEventListener('beforeunload', stopSessionPolling);
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â• ê´€ì°° ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â• -->
<div class="observe-overlay" id="observeOverlay" onclick="if(event.target===this)closeObserve()">
    <div class="observe-modal">
        <div class="observe-header">
            <h3 id="observeTitle">íŒ€ ê´€ì°°</h3>
            <button class="close-btn" onclick="closeObserve()">âœ• ë‹«ê¸°</button>
        </div>
        <div class="observe-members" id="observeMembers">ë©¤ë²„: ë¡œë”©ì¤‘...</div>
        <div class="observe-scenario-tabs" id="observeScenarios"></div>
        <div class="observe-chat" id="observeChat"></div>
        <div class="observe-status" id="observeStatus">ì‹¤ì‹œê°„ ê´€ì°° ì¤‘...</div>
    </div>
</div>

<script>
let observeInterval = null;
let observeTeamId = null;
let observeSessionId = null;
let observeScenarioId = null;
let observeLogCount = 0;

async function openObserve(sessionId, teamId, teamCode) {
    observeSessionId = sessionId;
    observeTeamId = teamId;
    observeLogCount = 0;

    document.getElementById('observeTitle').textContent = `ğŸ” Team ${teamCode} ê´€ì°°`;
    document.getElementById('observeChat').innerHTML = '';
    document.getElementById('observeOverlay').classList.add('open');

    try {
        const res = await fetch(`/api/rp-admin/team-scenarios?session_id=${sessionId}&team_id=${teamId}`);
        const data = await res.json();

        if (data.members?.length) {
            document.getElementById('observeMembers').textContent =
                'ë©¤ë²„: ' + data.members.map(m => m.full_name || m.user_id).join(', ');
        } else {
            document.getElementById('observeMembers').textContent = 'ë©¤ë²„: (ì•„ì§ ì—†ìŒ)';
        }

        const tabArea = document.getElementById('observeScenarios');
        if (data.scenarios?.length) {
            tabArea.innerHTML = data.scenarios.map((sc, i) =>
                `<button onclick="switchObserveScenario(${sc.scenario_id})" 
                         id="ob-sc-${sc.scenario_id}" 
                         class="${i === 0 ? 'active' : ''}">
                    ${sc.title || sc.npc_name}
                </button>`
            ).join('');
            observeScenarioId = data.scenarios[0].scenario_id;
        }
    } catch (e) {
        console.error('ê´€ì°° ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    await loadObserveHistory();
    observeInterval = setInterval(loadObserveHistory, 3000);
}

function closeObserve() {
    document.getElementById('observeOverlay').classList.remove('open');
    if (observeInterval) { clearInterval(observeInterval); observeInterval = null; }
    observeTeamId = null;
    observeScenarioId = null;
    observeLogCount = 0;
}

function switchObserveScenario(scenarioId) {
    observeScenarioId = scenarioId;
    observeLogCount = 0;
    document.getElementById('observeChat').innerHTML = '';
    document.querySelectorAll('.observe-scenario-tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(`ob-sc-${scenarioId}`)?.classList.add('active');
    loadObserveHistory();
}

async function loadObserveHistory() {
    if (!observeTeamId || !observeScenarioId) return;

    try {
        const res = await fetch(
            `/api/rp-admin/team-history?team_id=${observeTeamId}&scenario_id=${observeScenarioId}`
        );
        const data = await res.json();
        if (!data.logs) return;

        if (data.logs.length > observeLogCount) {
            const newLogs = data.logs.slice(observeLogCount);
            const chat = document.getElementById('observeChat');

            for (const log of newLogs) {
                const msg = document.createElement('div');

                if (log.speaker === 'player') {
                    const text = log.message_text || 'ğŸ¤ (Audio)';
                    const who = log.player_user_id || '';
                    msg.className = 'ob-msg player';
                    msg.innerHTML = `<div class="ob-label">${who}</div>${escapeObserve(text)}<div class="ob-meta">T${log.turn_number}</div>`;
                } else if (log.speaker === 'npc') {
                    const text = log.actor_line || log.message_text || '';
                    if (text === '[EXIT]' || text === '[GOAL_ACHIEVED]' || text === '[BOUNDARY_PRE]') {
                        msg.className = 'ob-msg system';
                        const label = {'[EXIT]':'ğŸšª NPC í‡´ì¥','[GOAL_ACHIEVED]':'ğŸ¯ ëª©ì  ë‹¬ì„±','[BOUNDARY_PRE]':'âš ï¸ Boundary PRE'}[text] || text;
                        msg.textContent = label;
                    } else {
                        msg.className = 'ob-msg npc';
                        msg.innerHTML = `<div class="ob-label">NPC</div>${escapeObserve(text)}<div class="ob-meta">T${log.turn_number}</div>`;
                    }
                }

                chat.appendChild(msg);
            }

            chat.scrollTop = chat.scrollHeight;
            observeLogCount = data.logs.length;
        }

        document.getElementById('observeStatus').textContent =
            `í„´ ${data.current_turn}/8 | ì‹¤ì‹œê°„ ê´€ì°° ì¤‘... (${new Date().toLocaleTimeString('ko-KR')})`;

    } catch (e) {
        console.error('ê´€ì°° í´ë§ ì‹¤íŒ¨:', e);
    }
}

function escapeObserve(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

</body>
</html>