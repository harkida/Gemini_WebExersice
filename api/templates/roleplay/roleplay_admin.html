<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ­ Roleplay Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #0f1117;
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* â”€â”€ í—¤ë” â”€â”€ */
        .header {
            background: linear-gradient(135deg, #1a1d2e 0%, #0f1117 100%);
            border-bottom: 1px solid #2a2d3e;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 { font-size: 20px; font-weight: 700; color: #fff; }
        .header h1 span { color: #7c6ff7; }
        .header-actions a {
            color: #888;
            text-decoration: none;
            font-size: 13px;
            padding: 6px 14px;
            border: 1px solid #333;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .header-actions a:hover { color: #fff; border-color: #555; }

        /* â”€â”€ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ */
        .tab-nav {
            display: flex;
            gap: 0;
            background: #1a1d2e;
            border-bottom: 1px solid #2a2d3e;
            padding: 0 24px;
        }
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-family: inherit;
        }
        .tab-btn:hover { color: #aaa; }
        .tab-btn.active { color: #7c6ff7; border-bottom-color: #7c6ff7; }

        /* â”€â”€ ë©”ì¸ ì»¨í…ì¸  â”€â”€ */
        .main { padding: 24px; max-width: 1100px; margin: 0 auto; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* â”€â”€ ì¹´ë“œ â”€â”€ */
        .card {
            background: #1a1d2e;
            border: 1px solid #2a2d3e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .card-title { font-size: 16px; font-weight: 700; color: #fff; }
        .card-id { font-size: 12px; color: #555; font-family: monospace; }

        .card-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 6px 12px;
            font-size: 13px;
        }
        .card-grid .label { color: #666; text-align: right; }
        .card-grid .value { color: #ccc; word-break: break-word; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge-low { background: #2d1f1f; color: #ff6b6b; }
        .badge-medium { background: #2d2a1f; color: #ffd43b; }
        .badge-high { background: #1f2d1f; color: #69db7c; }

        /* â”€â”€ í¼ â”€â”€ */
        .form-section { margin-bottom: 20px; }
        .form-section h3 {
            font-size: 13px;
            color: #7c6ff7;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .form-row.full { grid-template-columns: 1fr; }

        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            background: #0f1117;
            border: 1px solid #2a2d3e;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e0e0e0;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #7c6ff7;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }

        .checkbox-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #ccc;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            accent-color: #7c6ff7;
            width: 16px;
            height: 16px;
        }

        /* â”€â”€ ë²„íŠ¼ â”€â”€ */
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .btn-primary { background: #7c6ff7; color: #fff; }
        .btn-primary:hover { background: #6b5ce7; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #c82333; }
        .btn-ghost {
            background: none;
            border: 1px solid #333;
            color: #888;
        }
        .btn-ghost:hover { border-color: #555; color: #ccc; }

        .btn-row { display: flex; gap: 8px; margin-top: 16px; }

        /* â”€â”€ ìƒíƒœ ë©”ì‹œì§€ â”€â”€ */
        .status-msg {
            padding: 10px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            display: none;
        }
        .status-msg.success { display: block; background: #1a2e1a; color: #69db7c; border: 1px solid #2d4a2d; }
        .status-msg.error { display: block; background: #2e1a1a; color: #ff6b6b; border: 1px solid #4a2d2d; }

        /* â”€â”€ ë¹ˆ ìƒíƒœ â”€â”€ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #555;
            font-size: 14px;
        }

        /* â”€â”€ PRE í…Œì´ë¸” â”€â”€ */
        .pre-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .pre-table th {
            text-align: left;
            padding: 8px 12px;
            color: #666;
            font-weight: 500;
            border-bottom: 1px solid #2a2d3e;
        }
        .pre-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #1a1d2e;
            color: #ccc;
        }
        .pre-table tr:hover td { background: #1f2233; }

        /* â”€â”€ í† ê¸€ í¼ì¹˜ê¸° â”€â”€ */
        .expandable { cursor: pointer; }
        .expandable:hover .card-title { color: #7c6ff7; }
        .expand-content { display: none; margin-top: 12px; }
        .expand-content.open { display: block; }
    </style>
</head>
<body>

<!-- â”€â”€ í—¤ë” â”€â”€ -->
<div class="header">
    <h1>ğŸ­ <span>Roleplay</span> Admin</h1>
    <div class="header-actions">
        <a href="/dashboard">â† êµì‚¬ ëŒ€ì‹œë³´ë“œ</a>
    </div>
</div>

<!-- â”€â”€ íƒ­ â”€â”€ -->
<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('scenarios')">ì‹œë‚˜ë¦¬ì˜¤</button>
    <button class="tab-btn" onclick="switchTab('goals')">ëª©í‘œ</button>
    <button class="tab-btn" onclick="switchTab('pre')">PRE ë…¹ìŒ</button>
</div>

<div class="main">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- íƒ­ 1: ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-scenarios" class="tab-content active">

        <div id="scenario-status" class="status-msg"></div>

        <!-- ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€ í¼ -->
        <div class="card" style="border-color: #7c6ff740;">
            <div class="card-header">
                <div class="card-title">â• ìƒˆ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€</div>
            </div>

            <div class="form-section">
                <h3>ê¸°ë³¸ ì •ë³´</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œë‚˜ë¦¬ì˜¤ ì œëª© *</label>
                        <input type="text" id="sc-title" placeholder="ì˜ˆ: ì¹´í˜ ì£¼ë¬¸">
                    </div>
                    <div class="form-group">
                        <label>NPC Voice ID</label>
                        <input type="text" id="sc-voice-id" placeholder="ElevenLabs Voice ID">
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>ìƒí™© ì„¤ëª…</label>
                        <textarea id="sc-situation" placeholder="í•™ìƒì´ ì¹´í˜ì— ë“¤ì–´ê°€ì„œ ìŒë£Œë¥¼ ì£¼ë¬¸í•´ì•¼ í•©ë‹ˆë‹¤..."></textarea>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>ëŒ€í™” ëª©í‘œ (Boundary íŒë‹¨ ê¸°ì¤€)</label>
                        <textarea id="sc-conv-goal" placeholder="ìŒë£Œë¥¼ ì£¼ë¬¸í•˜ê³  ê²°ì œí•œë‹¤"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>NPC ì„¤ì •</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>NPC ì´ë¦„</label>
                        <input type="text" id="sc-npc-name" placeholder="ê¹€ìˆ˜ì§„">
                    </div>
                    <div class="form-group">
                        <label>NPC ë‚˜ì´</label>
                        <input type="number" id="sc-npc-age" placeholder="25">
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>NPC ì§ì—…</label>
                        <input type="text" id="sc-npc-job" placeholder="ì¹´í˜ ì ì›">
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>NPC ì„±ê²©</label>
                        <textarea id="sc-npc-personality" placeholder="ë°ê³  ì¹œì ˆí•œ ì„±ê²©. ì†ë‹˜ì—ê²Œ í•­ìƒ ë¯¸ì†Œë¥¼ ì§“ëŠ”ë‹¤."></textarea>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>NPC í˜„ì¬ ìƒíƒœ</label>
                        <textarea id="sc-npc-state" placeholder="ì˜¤ì „ 10ì‹œ, ë§¤ì¥ì´ í•œê°€í•œ ìƒíƒœ. ì¹´ìš´í„° ì•ì— ì„œì„œ ëŒ€ê¸° ì¤‘."></textarea>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>NPC ë„ë©”ì¸ ì§€ì‹ (JSON)</label>
                        <textarea id="sc-npc-knowledge" rows="3" placeholder='{"ë©”ë‰´": ["ì•„ë©”ë¦¬ì¹´ë…¸", "ì¹´í˜ë¼ë–¼"], "ì‚¬ì´ì¦ˆ": ["ë ˆê·¤ëŸ¬", "ë¼ì§€"]}'></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Boundary ì„¤ì •</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tolerance (Game Over ì„ê³„ê°’)</label>
                        <select id="sc-tolerance">
                            <option value="low">Low (score 6) â€” ì„œë¹„ìŠ¤ ê´€ê³„</option>
                            <option value="medium">Medium (score 9) â€” ê³µì‹ì  ì¹œë°€</option>
                            <option value="high">High (score 12) â€” ë¹„ê³µì‹ ì¹œë°€</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 8px;">
                    <label>Boundary DYN ì „ëµ</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="sc-strat-ask" checked> ë˜ë¬»ê¸°</label>
                        <label><input type="checkbox" id="sc-strat-intent" checked> ì €ì˜í™•ì¸</label>
                        <label><input type="checkbox" id="sc-strat-redirect" checked> ëª©í‘œí™˜ê¸°</label>
                    </div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="createScenario()">ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥</button>
                <button class="btn btn-ghost" onclick="clearScenarioForm()">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ -->
        <div id="scenario-list">
            <div class="empty-state">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- íƒ­ 2: ëª©í‘œ ê´€ë¦¬ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-goals" class="tab-content">

        <div id="goal-status" class="status-msg"></div>

        <div class="card" style="border-color: #7c6ff740;">
            <div class="card-header">
                <div class="card-title">â• ìƒˆ ëª©í‘œ ì¶”ê°€</div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ëª©í‘œ ì œëª© *</label>
                    <input type="text" id="gl-title" placeholder="ì¹´í˜ì—ì„œ ì£¼ë¬¸í•˜ê¸°">
                </div>
                <div class="form-group">
                    <label>ë°˜ (Class)</label>
                    <select id="gl-class">
                        <option value="3í•™ë…„">3í•™ë…„</option>
                        <option value="ì„ì‚¬1">ì„ì‚¬1</option>
                        <option value="ì„ì‚¬2">ì„ì‚¬2</option>
                    </select>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>ëª©í‘œ í‘œí˜„</label>
                    <input type="text" id="gl-expression" placeholder="ì£¼ì„¸ìš”, í• ê²Œìš”, ìˆì–´ìš”?, ì–¼ë§ˆì˜ˆìš”?">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ëª©í‘œ ë¬¸ë²•</label>
                    <input type="text" id="gl-grammar" placeholder="-ì•„/ì–´ ì£¼ì„¸ìš”, -(ìœ¼)ã„¹ê²Œìš”">
                </div>
                <div class="form-group">
                    <label>ëª©í‘œ ì–´íœ˜</label>
                    <input type="text" id="gl-vocabulary" placeholder="ì•„ë©”ë¦¬ì¹´ë…¸, ë¼ë–¼, ì¹´ë“œ, í˜„ê¸ˆ">
                </div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="createGoal()">ëª©í‘œ ì €ì¥</button>
            </div>
        </div>

        <div id="goal-list">
            <div class="empty-state">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- íƒ­ 3: PRE ë…¹ìŒ ê´€ë¦¬ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-pre" class="tab-content">

        <div id="pre-status" class="status-msg"></div>

        <div class="card" style="border-color: #7c6ff740;">
            <div class="card-header">
                <div class="card-title">â• PRE ë…¹ìŒ ë“±ë¡</div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ *</label>
                    <select id="pre-scenario-id">
                        <option value="">-- ë¨¼ì € ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ì„¸ìš” --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬ *</label>
                    <input type="text" id="pre-category" placeholder="greeting_cafe, size_ask, boundary_pre ë“±">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ë³€í˜• ë²ˆí˜¸ *</label>
                    <select id="pre-variant">
                        <option value="1">ë³€í˜• 1</option>
                        <option value="2">ë³€í˜• 2</option>
                        <option value="3">ë³€í˜• 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cloudflare R2 URL</label>
                    <input type="text" id="pre-url" placeholder="https://pub-xxx.r2.dev/cafe/greeting_1.mp3">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>ê°€ì´ë“œ (ë¶„ì„ê°€ìš©, boundary_preëŠ” ë¹„ì›Œë‘¬ë„ ë¨)</label>
                    <input type="text" id="pre-guide" placeholder="ì†ë‹˜ì´ ë§‰ ë“¤ì–´ì™”ì„ ë•Œ, ë˜ëŠ” ì£¼ë¬¸í•˜ê² ë‹¤ê³  ë§í•  ë•Œ">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>ëŒ€ì‚¬ í…ìŠ¤íŠ¸ (transcript) *</label>
                    <input type="text" id="pre-transcript" placeholder="ì–´ì„œì˜¤ì„¸ìš”~ ì£¼ë¬¸ ë„ì™€ë“œë¦´ê²Œìš”!">
                </div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="createPre()">PRE ë“±ë¡</button>
            </div>
        </div>

        <!-- PRE ëª©ë¡ (ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ì‹œ í‘œì‹œ) -->
        <div id="pre-list">
            <div class="empty-state">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ PRE ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
    </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    document.getElementById(`tab-${tab}`).classList.add('active');
    event.target.classList.add('active');

    if (tab === 'scenarios') loadScenarios();
    if (tab === 'goals') loadGoals();
    if (tab === 'pre') loadScenarioDropdown();
}

function showStatus(elementId, message, type) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = `status-msg ${type}`;
    setTimeout(() => { el.className = 'status-msg'; }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì‹œë‚˜ë¦¬ì˜¤ CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScenarios() {
    try {
        const res = await fetch('/api/rp-admin/scenarios');
        const data = await res.json();
        
        if (!data.scenarios || data.scenarios.length === 0) {
            document.getElementById('scenario-list').innerHTML = 
                '<div class="empty-state">ì•„ì§ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
            return;
        }

        let html = '';
        for (const s of data.scenarios) {
            const toleranceBadge = {
                low: '<span class="badge badge-low">Low</span>',
                medium: '<span class="badge badge-medium">Medium</span>',
                high: '<span class="badge badge-high">High</span>'
            }[s.boundary_tolerance] || '';

            const strategies = Array.isArray(s.boundary_strategies) 
                ? s.boundary_strategies.join(', ') 
                : (s.boundary_strategies || '');

            html += `
            <div class="card">
                <div class="card-header">
                    <div>
                        <span class="card-title">${s.title}</span>
                        <span class="card-id">ID: ${s.id}</span>
                    </div>
                    <button class="btn btn-danger" onclick="deleteScenario(${s.id})" style="font-size:11px; padding:4px 10px;">ì‚­ì œ</button>
                </div>
                <div class="card-grid">
                    <span class="label">ìƒí™©</span>
                    <span class="value">${s.situation || '-'}</span>
                    <span class="label">ëŒ€í™” ëª©í‘œ</span>
                    <span class="value">${s.conversation_goal || '-'}</span>
                    <span class="label">NPC</span>
                    <span class="value">${s.npc_name || '-'} (${s.npc_age || '?'}ì„¸, ${s.npc_job || '-'})</span>
                    <span class="label">ì„±ê²©</span>
                    <span class="value">${s.npc_personality || '-'}</span>
                    <span class="label">í˜„ì¬ ìƒíƒœ</span>
                    <span class="value">${s.npc_current_state || '-'}</span>
                    <span class="label">Voice ID</span>
                    <span class="value" style="font-family:monospace; font-size:11px;">${s.npc_voice_id || '-'}</span>
                    <span class="label">Boundary</span>
                    <span class="value">${toleranceBadge} â€” ì „ëµ: ${strategies || '-'}</span>
                </div>
            </div>`;
        }
        document.getElementById('scenario-list').innerHTML = html;
    } catch (e) {
        document.getElementById('scenario-list').innerHTML = 
            `<div class="empty-state" style="color:#ff6b6b;">ì˜¤ë¥˜: ${e.message}</div>`;
    }
}

async function createScenario() {
    const strategies = [];
    if (document.getElementById('sc-strat-ask').checked) strategies.push('ë˜ë¬»ê¸°');
    if (document.getElementById('sc-strat-intent').checked) strategies.push('ì €ì˜í™•ì¸');
    if (document.getElementById('sc-strat-redirect').checked) strategies.push('ëª©í‘œí™˜ê¸°');

    const payload = {
        title: document.getElementById('sc-title').value.trim(),
        situation: document.getElementById('sc-situation').value.trim(),
        conversation_goal: document.getElementById('sc-conv-goal').value.trim(),
        npc_name: document.getElementById('sc-npc-name').value.trim(),
        npc_age: parseInt(document.getElementById('sc-npc-age').value) || null,
        npc_job: document.getElementById('sc-npc-job').value.trim(),
        npc_personality: document.getElementById('sc-npc-personality').value.trim(),
        npc_current_state: document.getElementById('sc-npc-state').value.trim(),
        npc_voice_id: document.getElementById('sc-voice-id').value.trim(),
        boundary_tolerance: document.getElementById('sc-tolerance').value,
        boundary_strategies: strategies
    };

    // NPC Knowledge (JSON)
    const knowledgeStr = document.getElementById('sc-npc-knowledge').value.trim();
    if (knowledgeStr) {
        try {
            payload.npc_knowledge = knowledgeStr; // ë¬¸ìì—´ë¡œ ì „ë‹¬, ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬
            JSON.parse(knowledgeStr); // ìœ íš¨ì„±ë§Œ í™•ì¸
        } catch {
            showStatus('scenario-status', 'âŒ NPC ë„ë©”ì¸ ì§€ì‹ì´ ìœ íš¨í•œ JSONì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
            return;
        }
    }

    if (!payload.title) {
        showStatus('scenario-status', 'âŒ ì‹œë‚˜ë¦¬ì˜¤ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'error');
        return;
    }

    try {
        const res = await fetch('/api/rp-admin/scenarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            showStatus('scenario-status', `âœ… ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥ ì™„ë£Œ! (ID: ${data.id})`, 'success');
            clearScenarioForm();
            loadScenarios();
        } else {
            showStatus('scenario-status', `âŒ ${data.error}`, 'error');
        }
    } catch (e) {
        showStatus('scenario-status', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message}`, 'error');
    }
}

async function deleteScenario(id) {
    if (!confirm(`ì‹œë‚˜ë¦¬ì˜¤ ID ${id}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ê²°ëœ PRE ë…¹ìŒë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    try {
        const res = await fetch(`/api/rp-admin/scenarios/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            showStatus('scenario-status', 'âœ… ì‚­ì œ ì™„ë£Œ', 'success');
            loadScenarios();
        }
    } catch (e) {
        showStatus('scenario-status', `âŒ ${e.message}`, 'error');
    }
}

function clearScenarioForm() {
    ['sc-title','sc-situation','sc-conv-goal','sc-npc-name','sc-npc-age',
     'sc-npc-job','sc-npc-personality','sc-npc-state','sc-npc-knowledge','sc-voice-id'
    ].forEach(id => document.getElementById(id).value = '');
    document.getElementById('sc-tolerance').value = 'low';
    document.getElementById('sc-strat-ask').checked = true;
    document.getElementById('sc-strat-intent').checked = true;
    document.getElementById('sc-strat-redirect').checked = true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ëª©í‘œ CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGoals() {
    try {
        const res = await fetch('/api/rp-admin/goals');
        const data = await res.json();
        
        if (!data.goals || data.goals.length === 0) {
            document.getElementById('goal-list').innerHTML = 
                '<div class="empty-state">ì•„ì§ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '';
        for (const g of data.goals) {
            html += `
            <div class="card">
                <div class="card-header">
                    <div>
                        <span class="card-title">${g.title}</span>
                        <span class="card-id">ID: ${g.id} Â· ${g.class_name || '-'}</span>
                    </div>
                </div>
                <div class="card-grid">
                    <span class="label">í‘œí˜„</span>
                    <span class="value">${g.target_expression || '-'}</span>
                    <span class="label">ë¬¸ë²•</span>
                    <span class="value">${g.target_grammar || '-'}</span>
                    <span class="label">ì–´íœ˜</span>
                    <span class="value">${g.target_vocabulary || '-'}</span>
                </div>
            </div>`;
        }
        document.getElementById('goal-list').innerHTML = html;
    } catch (e) {
        document.getElementById('goal-list').innerHTML = 
            `<div class="empty-state" style="color:#ff6b6b;">ì˜¤ë¥˜: ${e.message}</div>`;
    }
}

async function createGoal() {
    const payload = {
        title: document.getElementById('gl-title').value.trim(),
        target_expression: document.getElementById('gl-expression').value.trim(),
        target_grammar: document.getElementById('gl-grammar').value.trim(),
        target_vocabulary: document.getElementById('gl-vocabulary').value.trim(),
        class_name: document.getElementById('gl-class').value
    };

    if (!payload.title) {
        showStatus('goal-status', 'âŒ ëª©í‘œ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'error');
        return;
    }

    try {
        const res = await fetch('/api/rp-admin/goals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            showStatus('goal-status', `âœ… ëª©í‘œ ì €ì¥ ì™„ë£Œ! (ID: ${data.id})`, 'success');
            ['gl-title','gl-expression','gl-grammar','gl-vocabulary'].forEach(id => document.getElementById(id).value = '');
            loadGoals();
        } else {
            showStatus('goal-status', `âŒ ${data.error}`, 'error');
        }
    } catch (e) {
        showStatus('goal-status', `âŒ ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRE ë…¹ìŒ CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScenarioDropdown() {
    try {
        const res = await fetch('/api/rp-admin/scenarios');
        const data = await res.json();
        const select = document.getElementById('pre-scenario-id');
        select.innerHTML = '<option value="">-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ --</option>';
        
        if (data.scenarios) {
            for (const s of data.scenarios) {
                select.innerHTML += `<option value="${s.id}">${s.title} (ID: ${s.id})</option>`;
            }
        }
    } catch (e) {
        console.error('ì‹œë‚˜ë¦¬ì˜¤ ë“œë¡­ë‹¤ìš´ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
}

// ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ì‹œ PRE ëª©ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    const preSelect = document.getElementById('pre-scenario-id');
    if (preSelect) {
        preSelect.addEventListener('change', () => {
            const scenarioId = preSelect.value;
            if (scenarioId) loadPreRecordings(scenarioId);
            else document.getElementById('pre-list').innerHTML = 
                '<div class="empty-state">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ PRE ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        });
    }
});

async function loadPreRecordings(scenarioId) {
    try {
        const res = await fetch(`/api/rp-admin/pre-recordings/${scenarioId}`);
        const data = await res.json();

        if (!data.recordings || data.recordings.length === 0) {
            document.getElementById('pre-list').innerHTML = 
                '<div class="empty-state">ì´ ì‹œë‚˜ë¦¬ì˜¤ì— ë“±ë¡ëœ PREê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '<div class="card"><table class="pre-table"><thead><tr>' +
            '<th>ì¹´í…Œê³ ë¦¬</th><th>ë³€í˜•</th><th>ëŒ€ì‚¬</th><th>ê°€ì´ë“œ</th><th>R2 URL</th><th></th>' +
            '</tr></thead><tbody>';

        for (const r of data.recordings) {
            const urlShort = r.cloudflare_url 
                ? `<a href="${r.cloudflare_url}" target="_blank" style="color:#7c6ff7;">ğŸ”— ë§í¬</a>` 
                : '-';
            html += `<tr>
                <td><strong>${r.category}</strong></td>
                <td>${r.variant}</td>
                <td>${r.transcript || '-'}</td>
                <td style="color:#888; font-size:12px;">${r.guide_text || '-'}</td>
                <td>${urlShort}</td>
                <td><button class="btn btn-danger" style="font-size:11px; padding:2px 8px;" onclick="deletePre(${r.id})">âœ•</button></td>
            </tr>`;
        }

        html += '</tbody></table></div>';
        document.getElementById('pre-list').innerHTML = html;
    } catch (e) {
        document.getElementById('pre-list').innerHTML = 
            `<div class="empty-state" style="color:#ff6b6b;">ì˜¤ë¥˜: ${e.message}</div>`;
    }
}

async function createPre() {
    const payload = {
        scenario_id: parseInt(document.getElementById('pre-scenario-id').value),
        category: document.getElementById('pre-category').value.trim(),
        variant: parseInt(document.getElementById('pre-variant').value),
        guide_text: document.getElementById('pre-guide').value.trim() || null,
        transcript: document.getElementById('pre-transcript').value.trim(),
        cloudflare_url: document.getElementById('pre-url').value.trim() || null
    };

    if (!payload.scenario_id || !payload.category || !payload.transcript) {
        showStatus('pre-status', 'âŒ ì‹œë‚˜ë¦¬ì˜¤, ì¹´í…Œê³ ë¦¬, ëŒ€ì‚¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.', 'error');
        return;
    }

    try {
        const res = await fetch('/api/rp-admin/pre-recordings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            showStatus('pre-status', `âœ… PRE ë“±ë¡ ì™„ë£Œ! (ID: ${data.id})`, 'success');
            document.getElementById('pre-transcript').value = '';
            document.getElementById('pre-url').value = '';
            loadPreRecordings(payload.scenario_id);
        } else {
            showStatus('pre-status', `âŒ ${data.error}`, 'error');
        }
    } catch (e) {
        showStatus('pre-status', `âŒ ${e.message}`, 'error');
    }
}

async function deletePre(id) {
    if (!confirm('ì´ PRE ë…¹ìŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        const res = await fetch(`/api/rp-admin/pre-recordings/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            showStatus('pre-status', 'âœ… ì‚­ì œ ì™„ë£Œ', 'success');
            const scenarioId = document.getElementById('pre-scenario-id').value;
            if (scenarioId) loadPreRecordings(scenarioId);
        }
    } catch (e) {
        showStatus('pre-status', `âŒ ${e.message}`, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸° ë¡œë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadScenarios();
</script>

</body>
</html>