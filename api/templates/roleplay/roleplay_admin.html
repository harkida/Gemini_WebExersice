<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ­ Roleplay Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #0f1117;
            color: #e0e0e0;
            min-height: 100vh;
            font-size: 15px;
        }

        /* â”€â”€ í—¤ë” â”€â”€ */
        .header {
            background: linear-gradient(135deg, #1a1d2e 0%, #0f1117 100%);
            border-bottom: 1px solid #2a2d3e;
            padding: 18px 28px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header h1 { font-size: 22px; font-weight: 700; color: #fff; }
        .header h1 span { color: #7c6ff7; }
        .header-actions a {
            color: #888; text-decoration: none; font-size: 14px;
            padding: 8px 16px; border: 1px solid #333; border-radius: 6px; transition: all 0.2s;
        }
        .header-actions a:hover { color: #fff; border-color: #555; }

        /* â”€â”€ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ */
        .tab-nav {
            display: flex; gap: 0; background: #1a1d2e;
            border-bottom: 1px solid #2a2d3e; padding: 0 28px;
        }
        .tab-btn {
            padding: 14px 28px; background: none; border: none; color: #666;
            font-size: 15px; font-weight: 500; cursor: pointer;
            border-bottom: 2px solid transparent; transition: all 0.2s; font-family: inherit;
        }
        .tab-btn:hover { color: #aaa; }
        .tab-btn.active { color: #7c6ff7; border-bottom-color: #7c6ff7; }

        /* â”€â”€ ë©”ì¸ ì»¨í…ì¸  â”€â”€ */
        .main { padding: 28px; max-width: 1200px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* â”€â”€ ì¹´ë“œ â”€â”€ */
        .card {
            background: #1a1d2e; border: 1px solid #2a2d3e;
            border-radius: 10px; padding: 22px; margin-bottom: 18px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;
        }
        .card-title { font-size: 18px; font-weight: 700; color: #fff; }
        .card-id { font-size: 13px; color: #555; font-family: monospace; margin-left: 10px; }
        .card-grid {
            display: grid; grid-template-columns: 110px 1fr; gap: 8px 14px; font-size: 15px;
        }
        .card-grid .label { color: #666; text-align: right; }
        .card-grid .value { color: #ccc; word-break: break-word; }

        .badge { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .badge-low { background: #2d1f1f; color: #ff6b6b; }
        .badge-medium { background: #2d2a1f; color: #ffd43b; }
        .badge-high { background: #1f2d1f; color: #69db7c; }

        /* â”€â”€ í¼ â”€â”€ */
        .form-section { margin-bottom: 22px; }
        .form-section h3 {
            font-size: 14px; color: #7c6ff7; margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 13px; color: #888; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select {
            background: #0f1117; border: 1px solid #2a2d3e; border-radius: 6px;
            padding: 10px 14px; color: #e0e0e0; font-size: 15px; font-family: inherit; transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: #7c6ff7;
        }
        .form-group textarea { resize: vertical; min-height: 70px; }

        .checkbox-group { display: flex; gap: 20px; align-items: center; }
        .checkbox-group label {
            display: flex; align-items: center; gap: 6px; font-size: 15px; color: #ccc; cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] { accent-color: #7c6ff7; width: 18px; height: 18px; }

        /* â”€â”€ ë²„íŠ¼ â”€â”€ */
        .btn {
            padding: 9px 22px; border: none; border-radius: 6px; font-size: 14px;
            font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s;
        }
        .btn-primary { background: #7c6ff7; color: #fff; }
        .btn-primary:hover { background: #6b5ce7; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #c82333; }
        .btn-ghost { background: none; border: 1px solid #333; color: #888; }
        .btn-ghost:hover { border-color: #555; color: #ccc; }
        .btn-sm { padding: 5px 12px; font-size: 13px; }
        .btn-row { display: flex; gap: 8px; margin-top: 18px; }
        .card-actions { display: flex; gap: 6px; }

        /* â”€â”€ ìƒíƒœ ë©”ì‹œì§€ â”€â”€ */
        .status-msg { padding: 12px 18px; border-radius: 6px; margin-bottom: 18px; font-size: 14px; display: none; }
        .status-msg.success { display: block; background: #1a2e1a; color: #69db7c; border: 1px solid #2d4a2d; }
        .status-msg.error { display: block; background: #2e1a1a; color: #ff6b6b; border: 1px solid #4a2d2d; }
        .empty-state { text-align: center; padding: 40px; color: #555; font-size: 15px; }

        /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: #1a1d2e; border: 1px solid #2a2d3e; border-radius: 12px;
            padding: 28px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto;
        }
        .modal h2 { font-size: 20px; color: #fff; margin-bottom: 20px; }

        /* â”€â”€ PRE ì•„ì½”ë””ì–¸ â”€â”€ */
        .accordion-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px; background: #1a1d2e; border: 1px solid #2a2d3e;
            border-radius: 8px; cursor: pointer; margin-bottom: 4px; transition: background 0.15s;
        }
        .accordion-header:hover { background: #1f2233; }
        .accordion-header .arrow { font-size: 14px; color: #666; transition: transform 0.2s; }
        .accordion-header.open .arrow { transform: rotate(90deg); }
        .accordion-header .cat-name { font-size: 16px; font-weight: 600; color: #fff; }
        .accordion-header .cat-count { font-size: 13px; color: #666; margin-left: 8px; }
        .accordion-header .cat-guide { font-size: 13px; color: #555; margin-left: 16px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .accordion-body { display: none; padding: 8px 0 12px 0; }
        .accordion-body.open { display: block; }
        .variant-row {
            display: grid; grid-template-columns: 50px 1fr 100px 80px;
            gap: 12px; align-items: center; padding: 10px 18px; font-size: 14px;
            border-bottom: 1px solid #1a1d2e;
        }
        .variant-row:hover { background: #1f2233; }
        .variant-num { color: #666; font-size: 13px; }
        .variant-transcript { color: #e0e0e0; }
        .variant-url a { color: #7c6ff7; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ­ <span>Roleplay</span> Admin</h1>
    <div class="header-actions"><a href="/dashboard">â† êµì‚¬ ëŒ€ì‹œë³´ë“œ</a></div>
</div>

<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('scenarios')">ì‹œë‚˜ë¦¬ì˜¤</button>
    <button class="tab-btn" onclick="switchTab('goals')">ëª©í‘œ</button>
    <button class="tab-btn" onclick="switchTab('pre')">PRE ë…¹ìŒ</button>
</div>

<div class="main">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ 1: ì‹œë‚˜ë¦¬ì˜¤ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-scenarios" class="tab-content active">
    <div id="scenario-status" class="status-msg"></div>

    <div class="card" style="border-color: #7c6ff740;">
        <div class="card-header"><div class="card-title">â• ìƒˆ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€</div></div>

        <div class="form-section">
            <h3>ê¸°ë³¸ ì •ë³´</h3>
            <div class="form-row">
                <div class="form-group"><label>ì‹œë‚˜ë¦¬ì˜¤ ì œëª© *</label><input type="text" id="sc-title" placeholder="ì˜ˆ: ì¹´í˜ ì£¼ë¬¸"></div>
                <div class="form-group"><label>NPC Voice ID</label><input type="text" id="sc-voice-id" placeholder="ElevenLabs Voice ID"></div>
            </div>
            <div class="form-row full"><div class="form-group"><label>ìƒí™© ì„¤ëª…</label><textarea id="sc-situation" placeholder="í”Œë ˆì´ì–´ê°€ ì¹´í˜ì— ë“¤ì–´ê°€ì„œ..."></textarea></div></div>
            <div class="form-row full"><div class="form-group"><label>ëŒ€í™” ëª©í‘œ (Boundary íŒë‹¨ ê¸°ì¤€)</label><textarea id="sc-conv-goal" placeholder="ìŒë£Œë¥¼ ì£¼ë¬¸í•˜ê³  ê²°ì œí•œë‹¤"></textarea></div></div>
            <div class="form-row full"><div class="form-group"><label>ğŸ‡®ğŸ‡¹ Obiettivo (í•™ìƒì—ê²Œ ë³´ì´ëŠ” ì´íƒˆë¦¬ì•„ì–´ ëª©í‘œ)</label><textarea id="sc-objective-it" placeholder="Ordina una bevanda al bar e paga"></textarea></div></div>
        </div>

        <div class="form-section">
            <h3>NPC ì„¤ì •</h3>
            <div class="form-row">
                <div class="form-group"><label>NPC ì´ë¦„</label><input type="text" id="sc-npc-name" placeholder="ê¹€ìˆ˜ì§„"></div>
                <div class="form-group"><label>NPC ë‚˜ì´</label><input type="number" id="sc-npc-age" placeholder="25"></div>
            </div>
            <div class="form-row full"><div class="form-group"><label>NPC ì§ì—…</label><input type="text" id="sc-npc-job" placeholder="ì¹´í˜ ì ì›"></div></div>
            <div class="form-row full"><div class="form-group"><label>NPC ì„±ê²©</label><textarea id="sc-npc-personality" placeholder="ë°ê³  ì¹œì ˆí•œ ì„±ê²©..."></textarea></div></div>
            <div class="form-row full"><div class="form-group"><label>NPC í˜„ì¬ ìƒíƒœ</label><textarea id="sc-npc-state" placeholder="ì˜¤ì „ 10ì‹œ, ë§¤ì¥ì´ í•œê°€í•œ ìƒíƒœ..."></textarea></div></div>
            <div class="form-row full"><div class="form-group"><label>NPC ë„ë©”ì¸ ì§€ì‹ (JSON)</label><textarea id="sc-npc-knowledge" rows="3" placeholder='{"ë©”ë‰´": [...], "ì‚¬ì´ì¦ˆ": [...]}'></textarea></div></div>
        </div>

        <div class="form-section">
            <h3>AI ì„¤ì •</h3>
            <div class="form-row">
                <div class="form-group"><label>Temperature (ì°½ì˜ì„±)</label>
                    <select id="sc-temperature">
                        <option value="0.2">0.2 â€” ë§¤ìš° ë³´ìˆ˜ì </option>
                        <option value="0.3" selected>0.3 â€” ë³´ìˆ˜ì  (ì¹´í˜, ì ‘ìˆ˜)</option>
                        <option value="0.5">0.5 â€” ì¤‘ê°„ (ì„ ìƒë‹˜, ìƒì‚¬)</option>
                        <option value="0.7">0.7 â€” ìœ ì—° (ì¹œêµ¬, í† ë¡ )</option>
                        <option value="0.9">0.9 â€” ë§¤ìš° ìœ ì—°</option>
                    </select>
                </div>
                <div class="form-group"><label>Thinking Level (ì‚¬ê³  ê¹Šì´)</label>
                    <select id="sc-thinking">
                        <option value="LOW" selected>LOW â€” ë¹ ë¦„ (ë‹¨ìˆœ ì‹œë‚˜ë¦¬ì˜¤)</option>
                        <option value="MEDIUM">MEDIUM â€” ê· í˜•</option>
                        <option value="HIGH">HIGH â€” ê¹ŠìŒ (ë³µì¡í•œ ì‹œë‚˜ë¦¬ì˜¤)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="createScenario()">ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥</button>
            <button class="btn btn-ghost" onclick="clearScenarioForm()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="scenario-list" style="margin-top: 30px;"><div class="empty-state">ë¡œë”© ì¤‘...</div></div>    
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ 2: ëª©í‘œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-goals" class="tab-content">
    <div id="goal-status" class="status-msg"></div>

    <div class="card" style="border-color: #7c6ff740;">
        <div class="card-header"><div class="card-title">â• ìƒˆ ëª©í‘œ ì¶”ê°€</div></div>
        <div class="form-row">
            <div class="form-group"><label>ëª©í‘œ ì œëª© *</label><input type="text" id="gl-title" placeholder="ì¹´í˜ì—ì„œ ì£¼ë¬¸í•˜ê¸°"></div>
        </div>
        <div class="form-row full"><div class="form-group"><label>ëª©í‘œ í‘œí˜„</label><input type="text" id="gl-expression" placeholder="ì£¼ì„¸ìš”, í• ê²Œìš”, ìˆì–´ìš”?"></div></div>
        <div class="form-row">
            <div class="form-group"><label>ëª©í‘œ ë¬¸ë²•</label><input type="text" id="gl-grammar" placeholder="-ì•„/ì–´ ì£¼ì„¸ìš”"></div>
            <div class="form-group"><label>ëª©í‘œ ì–´íœ˜</label><input type="text" id="gl-vocabulary" placeholder="ì•„ë©”ë¦¬ì¹´ë…¸, ë¼ë–¼"></div>
            <div class="form-group full"><label>ëŒ€í™” ëª©í‘œ (conversation_goal)</label><textarea id="gl-conv-goal" rows="3" placeholder="ì˜ˆ: í•™ìƒì´ ì¹´í˜ì—ì„œ ìŒë£Œë¥¼ ì£¼ë¬¸í•˜ê³  ê²°ì œê¹Œì§€ ì™„ë£Œí•œë‹¤."></textarea></div>
            <div class="form-group full"><label>NPC í–‰ë™ ë°©ì¹¨ (npc_guidelines)</label><textarea id="gl-npc-guide" rows="3" placeholder="ì˜ˆ: ê·¼í™©ì— ëŒ€í•´ í›„ì† ì§ˆë¬¸ì€ 1ë²ˆë§Œ í•œë‹¤. ê·¸ í›„ì—ëŠ” í•™ìƒì´ ì§ˆë¬¸í•  ìˆ˜ ìˆë„ë¡ ëŒ€í™”ë¥¼ ë„˜ê¸´ë‹¤."></textarea></div>
        </div>
        <div class="btn-row"><button class="btn btn-primary" onclick="createGoal()">ëª©í‘œ ì €ì¥</button></div>
    </div>

    <div id="goal-list"><div class="empty-state">ë¡œë”© ì¤‘...</div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ­ 3: PRE ë…¹ìŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-pre" class="tab-content">
    <div id="pre-status" class="status-msg"></div>

    <div class="card" style="border-color: #7c6ff740;">
        <div class="card-header"><div class="card-title">â• PRE ë…¹ìŒ ë“±ë¡</div></div>
        <div class="form-row">
            <div class="form-group"><label>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ *</label><select id="pre-scenario-id"><option value="">-- ë¨¼ì € ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ì„¸ìš” --</option></select></div>
            <div class="form-group"><label>ì¹´í…Œê³ ë¦¬ *</label><input type="text" id="pre-category" placeholder="greeting_cafe, boundary_pre ë“±"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>ë³€í˜• ë²ˆí˜¸ *</label>
                <select id="pre-variant"><option value="1">ë³€í˜• 1</option><option value="2">ë³€í˜• 2</option><option value="3">ë³€í˜• 3</option></select>
            </div>
            <div class="form-group"><label>Cloudflare R2 URL</label><input type="text" id="pre-url" placeholder="https://pub-xxx.r2.dev/..."></div>
        </div>
        <div class="form-row full"><div class="form-group"><label>ê°€ì´ë“œ (ë¶„ì„ê°€ìš©)</label><input type="text" id="pre-guide" placeholder="ì†ë‹˜ì´ ë§‰ ë“¤ì–´ì™”ì„ ë•Œ"></div></div>
        <div class="form-row full"><div class="form-group"><label>ëŒ€ì‚¬ í…ìŠ¤íŠ¸ *</label><input type="text" id="pre-transcript" placeholder="ì–´ì„œì˜¤ì„¸ìš”~ ì£¼ë¬¸ ë„ì™€ë“œë¦´ê²Œìš”!"></div></div>
        <div class="btn-row"><button class="btn btn-primary" onclick="createPre()">PRE ë“±ë¡</button></div>
    </div>

    <div id="pre-list"><div class="empty-state">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ PRE ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div></div>
</div>

</div><!-- /main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìˆ˜ì • ëª¨ë‹¬ (ê³µìš©) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="edit-modal">
    <div class="modal">
        <h2 id="modal-title">ìˆ˜ì •</h2>
        <div id="modal-body"></div>
        <div class="btn-row" style="margin-top:20px;">
            <button class="btn btn-primary" id="modal-save-btn">ì €ì¥</button>
            <button class="btn btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìœ í‹¸ë¦¬í‹° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    event.target.classList.add('active');
    if (tab === 'scenarios') loadScenarios();
    if (tab === 'goals') loadGoals();
    if (tab === 'pre') loadScenarioDropdown();
}

function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg; el.className = `status-msg ${type}`;
    setTimeout(() => { el.className = 'status-msg'; }, 5000);
}

function openModal(title, bodyHtml, onSave) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHtml;
    document.getElementById('modal-save-btn').onclick = onSave;
    document.getElementById('edit-modal').classList.add('open');
}
function closeModal() { document.getElementById('edit-modal').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì‹œë‚˜ë¦¬ì˜¤ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScenarios() {
    try {
        const res = await fetch('/api/rp-admin/scenarios');
        const data = await res.json();
        if (!data.scenarios?.length) {
            document.getElementById('scenario-list').innerHTML = '<div class="empty-state">ì•„ì§ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        let html = '';
        for (const s of data.scenarios) {
            html += `
            <div class="card">
                <div class="card-header">
                    <div><span class="card-title">${s.title}</span><span class="card-id">ID: ${s.id}</span></div>
                    <div class="card-actions">
                        <button class="btn btn-ghost btn-sm" onclick='editScenario(${JSON.stringify(s).replace(/'/g,"&#39;")})'>ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteScenario(${s.id})">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="card-grid">
                    <span class="label">ìƒí™©</span><span class="value">${s.situation||'-'}</span>
                    <span class="label">ëŒ€í™” ëª©í‘œ</span><span class="value">${s.conversation_goal||'-'}</span>
                    <span class="label">NPC</span><span class="value">${s.npc_name||'-'} (${s.npc_age||'?'}ì„¸, ${s.npc_job||'-'})</span>
                    <span class="label">ì„±ê²©</span><span class="value">${s.npc_personality||'-'}</span>
                    <span class="label">í˜„ì¬ ìƒíƒœ</span><span class="value">${s.npc_current_state||'-'}</span>
                    <span class="label">Voice ID</span><span class="value" style="font-family:monospace;font-size:13px;">${s.npc_voice_id||'-'}</span>
                    <span class="label">AI ì„¤ì •</span><span class="value">Temp: ${s.temperature||0.3} / Think: ${s.thinking_level||'LOW'}</span>
                </div>
            </div>`;
        }
        document.getElementById('scenario-list').innerHTML = html;
    } catch (e) {
        document.getElementById('scenario-list').innerHTML = `<div class="empty-state" style="color:#ff6b6b;">ì˜¤ë¥˜: ${e.message}</div>`;
    }
}

function editScenario(s) {
    const knowledge = typeof s.npc_knowledge === 'object' ? JSON.stringify(s.npc_knowledge, null, 2) : (s.npc_knowledge || '');
    
    const html = `
    <div class="form-row"><div class="form-group"><label>ì œëª©</label><input id="ed-sc-title" value="${s.title||''}"></div>
    <div class="form-group"><label>Voice ID</label><input id="ed-sc-voice" value="${s.npc_voice_id||''}"></div></div>
    <div class="form-row full"><div class="form-group"><label>ìƒí™©</label><textarea id="ed-sc-situation">${s.situation||''}</textarea></div></div>
    <div class="form-row full"><div class="form-group"><label>ëŒ€í™” ëª©í‘œ</label><textarea id="ed-sc-goal">${s.conversation_goal||''}</textarea></div></div>
    <div class="form-row full"><div class="form-group"><label>ğŸ‡®ğŸ‡¹ Obiettivo</label><textarea id="ed-sc-objective-it">${s.objective_it||''}</textarea></div></div>
    <div class="form-row">
        <div class="form-group"><label>NPC ì´ë¦„</label><input id="ed-sc-name" value="${s.npc_name||''}"></div>
        <div class="form-group"><label>ë‚˜ì´</label><input type="number" id="ed-sc-age" value="${s.npc_age||''}"></div>
    </div>
    <div class="form-row full"><div class="form-group"><label>ì§ì—…</label><input id="ed-sc-job" value="${s.npc_job||''}"></div></div>
    <div class="form-row full"><div class="form-group"><label>ì„±ê²©</label><textarea id="ed-sc-personality">${s.npc_personality||''}</textarea></div></div>
    <div class="form-row full"><div class="form-group"><label>í˜„ì¬ ìƒíƒœ</label><textarea id="ed-sc-state">${s.npc_current_state||''}</textarea></div></div>
    <div class="form-row full"><div class="form-group"><label>ë„ë©”ì¸ ì§€ì‹ (JSON)</label><textarea id="ed-sc-knowledge" rows="4">${knowledge}</textarea></div></div>
    <div class="form-row">
        <div class="form-group"><label>Temperature</label>
            <select id="ed-sc-temperature">
                <option value="0.2" ${s.temperature==0.2?'selected':''}>0.2</option>
                <option value="0.3" ${s.temperature==0.3||!s.temperature?'selected':''}>0.3</option>
                <option value="0.5" ${s.temperature==0.5?'selected':''}>0.5</option>
                <option value="0.7" ${s.temperature==0.7?'selected':''}>0.7</option>
                <option value="0.9" ${s.temperature==0.9?'selected':''}>0.9</option>
            </select>
        </div>
        <div class="form-group"><label>Thinking Level</label>
            <select id="ed-sc-thinking">
                <option value="LOW" ${s.thinking_level==='LOW'||!s.thinking_level?'selected':''}>LOW</option>
                <option value="MEDIUM" ${s.thinking_level==='MEDIUM'?'selected':''}>MEDIUM</option>
                <option value="HIGH" ${s.thinking_level==='HIGH'?'selected':''}>HIGH</option>
            </select>
        </div>
    </div>`;

    openModal(`ì‹œë‚˜ë¦¬ì˜¤ ìˆ˜ì • (ID: ${s.id})`, html, async () => {

        const payload = {
            title: document.getElementById('ed-sc-title').value.trim(),
            situation: document.getElementById('ed-sc-situation').value.trim(),
            conversation_goal: document.getElementById('ed-sc-goal').value.trim(),
            objective_it: document.getElementById('ed-sc-objective-it').value.trim(),
            npc_name: document.getElementById('ed-sc-name').value.trim(),
            npc_age: parseInt(document.getElementById('ed-sc-age').value) || null,
            npc_job: document.getElementById('ed-sc-job').value.trim(),
            npc_personality: document.getElementById('ed-sc-personality').value.trim(),
            npc_current_state: document.getElementById('ed-sc-state').value.trim(),
            npc_knowledge: document.getElementById('ed-sc-knowledge').value.trim() || null,
            npc_voice_id: document.getElementById('ed-sc-voice').value.trim(),
            temperature: parseFloat(document.getElementById('ed-sc-temperature').value),
            thinking_level: document.getElementById('ed-sc-thinking').value            
        };
        try {
            const res = await fetch(`/api/rp-admin/scenarios/${s.id}`, {
                method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) { closeModal(); showStatus('scenario-status','âœ… ìˆ˜ì • ì™„ë£Œ','success'); loadScenarios(); }
            else showStatus('scenario-status',`âŒ ${data.error}`,'error');
        } catch(e) { showStatus('scenario-status',`âŒ ${e.message}`,'error'); }
    });
}

async function createScenario() {
    const payload = {
        title: document.getElementById('sc-title').value.trim(),
        situation: document.getElementById('sc-situation').value.trim(),
        conversation_goal: document.getElementById('sc-conv-goal').value.trim(),
        objective_it: document.getElementById('sc-objective-it').value.trim(),
        npc_name: document.getElementById('sc-npc-name').value.trim(),
        npc_age: parseInt(document.getElementById('sc-npc-age').value) || null,
        npc_job: document.getElementById('sc-npc-job').value.trim(),
        npc_personality: document.getElementById('sc-npc-personality').value.trim(),
        npc_current_state: document.getElementById('sc-npc-state').value.trim(),
        npc_voice_id: document.getElementById('sc-voice-id').value.trim(),
        temperature: parseFloat(document.getElementById('sc-temperature').value),
        thinking_level: document.getElementById('sc-thinking').value,
    };
    const knowledgeStr = document.getElementById('sc-npc-knowledge').value.trim();
    if (knowledgeStr) { try { JSON.parse(knowledgeStr); payload.npc_knowledge = knowledgeStr; } catch { showStatus('scenario-status','âŒ JSON í˜•ì‹ ì˜¤ë¥˜','error'); return; } }
    if (!payload.title) { showStatus('scenario-status','âŒ ì œëª© í•„ìˆ˜','error'); return; }
    try {
        const res = await fetch('/api/rp-admin/scenarios', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const data = await res.json();
        if (data.success) { showStatus('scenario-status',`âœ… ì €ì¥ ì™„ë£Œ! (ID: ${data.id})`,'success'); clearScenarioForm(); loadScenarios(); }
        else showStatus('scenario-status',`âŒ ${data.error}`,'error');
    } catch(e) { showStatus('scenario-status',`âŒ ${e.message}`,'error'); }
}

async function deleteScenario(id) {
    if (!confirm(`ì‹œë‚˜ë¦¬ì˜¤ ID ${id} ì‚­ì œ?\nì—°ê²°ëœ PREë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    try {
        const res = await fetch(`/api/rp-admin/scenarios/${id}`, { method:'DELETE' });
        if ((await res.json()).success) { showStatus('scenario-status','âœ… ì‚­ì œ ì™„ë£Œ','success'); loadScenarios(); }
    } catch(e) { showStatus('scenario-status',`âŒ ${e.message}`,'error'); }
}

function clearScenarioForm() {
    ['sc-title','sc-situation','sc-conv-goal','sc-objective-it','sc-npc-name','sc-npc-age','sc-npc-job','sc-npc-personality','sc-npc-state','sc-npc-knowledge','sc-voice-id'].forEach(id => document.getElementById(id).value = '');    
    document.getElementById('sc-temperature').value = '0.3';
    document.getElementById('sc-thinking').value = 'LOW';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ëª©í‘œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGoals() {
    try {
        const res = await fetch('/api/rp-admin/goals');
        const data = await res.json();
        if (!data.goals?.length) { document.getElementById('goal-list').innerHTML = '<div class="empty-state">ì•„ì§ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
        let html = '';
        for (const g of data.goals) {
            html += `
            <div class="card">
                <div class="card-header">
                    <div><span class="card-title">${g.title}</span><span class="card-id">ID: ${g.id}</span></div>
                    <div class="card-actions">
                        <button class="btn btn-ghost btn-sm" onclick='editGoal(${JSON.stringify(g).replace(/'/g,"&#39;")})'>ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteGoal(${g.id})">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="card-grid">
                    <span class="label">í‘œí˜„</span><span class="value">${g.target_expression||'-'}</span>
                    <span class="label">ë¬¸ë²•</span><span class="value">${g.target_grammar||'-'}</span>
                    <span class="label">ì–´íœ˜</span><span class="value">${g.target_vocabulary||'-'}</span>
                    <span class="label">ëŒ€í™” ëª©í‘œ</span><span class="value">${g.conversation_goal||'-'}</span>
                    <span class="label">NPC ë°©ì¹¨</span><span class="value">${g.npc_guidelines||'-'}</span>                    
                </div>
            </div>`;
        }
        document.getElementById('goal-list').innerHTML = html;
    } catch(e) { document.getElementById('goal-list').innerHTML = `<div class="empty-state" style="color:#ff6b6b;">${e.message}</div>`; }
}

function editGoal(g) {
    const html = `
    <div class="form-row"><div class="form-group full"><label>ì œëª©</label><input id="ed-gl-title" value="${g.title||''}"></div></div>
    <div class="form-row full"><div class="form-group"><label>í‘œí˜„</label><input id="ed-gl-expr" value="${g.target_expression||''}"></div></div>
    <div class="form-row"><div class="form-group"><label>ë¬¸ë²•</label><input id="ed-gl-gram" value="${g.target_grammar||''}"></div>
    <div class="form-group"><label>ì–´íœ˜</label><input id="ed-gl-vocab" value="${g.target_vocabulary||''}"></div></div>
    <div class="form-row"><div class="form-group full"><label>ëŒ€í™” ëª©í‘œ</label><textarea id="ed-gl-conv-goal" rows="3">${g.conversation_goal||''}</textarea></div></div>
    <div class="form-row"><div class="form-group full"><label>NPC í–‰ë™ ë°©ì¹¨</label><textarea id="ed-gl-npc-guide" rows="3">${g.npc_guidelines||''}</textarea></div></div>`;

    openModal(`ëª©í‘œ ìˆ˜ì • (ID: ${g.id})`, html, async () => {
        const payload = {
            title: document.getElementById('ed-gl-title').value.trim(),
            target_expression: document.getElementById('ed-gl-expr').value.trim(),
            target_grammar: document.getElementById('ed-gl-gram').value.trim(),
            target_vocabulary: document.getElementById('ed-gl-vocab').value.trim(),
            conversation_goal: document.getElementById('ed-gl-conv-goal').value.trim(),
            npc_guidelines: document.getElementById('ed-gl-npc-guide').value.trim()
        };
        try {
            const res = await fetch(`/api/rp-admin/goals/${g.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            if ((await res.json()).success) { closeModal(); showStatus('goal-status','âœ… ìˆ˜ì • ì™„ë£Œ','success'); loadGoals(); }
        } catch(e) { showStatus('goal-status',`âŒ ${e.message}`,'error'); }
    });
}

async function createGoal() {
    const payload = {
        title: document.getElementById('gl-title').value.trim(),
        target_expression: document.getElementById('gl-expression').value.trim(),
        target_grammar: document.getElementById('gl-grammar').value.trim(),
        target_vocabulary: document.getElementById('gl-vocabulary').value.trim(),
        conversation_goal: document.getElementById('gl-conv-goal').value.trim(),
        npc_guidelines: document.getElementById('gl-npc-guide').value.trim()        
    };
    if (!payload.title) { showStatus('goal-status','âŒ ì œëª© í•„ìˆ˜','error'); return; }
    try {
        const res = await fetch('/api/rp-admin/goals', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const data = await res.json();
        if (data.success) { showStatus('goal-status',`âœ… ì €ì¥ ì™„ë£Œ! (ID: ${data.id})`,'success'); ['gl-title','gl-expression','gl-grammar','gl-vocabulary','gl-conv-goal','gl-npc-guide'].forEach(id=>document.getElementById(id).value=''); loadGoals(); }
        else showStatus('goal-status',`âŒ ${data.error}`,'error');
    } catch(e) { showStatus('goal-status',`âŒ ${e.message}`,'error'); }
}

async function deleteGoal(id) {
    if (!confirm(`ëª©í‘œ ID ${id} ì‚­ì œ?`)) return;
    try {
        const res = await fetch(`/api/rp-admin/goals/${id}`, { method:'DELETE' });
        if ((await res.json()).success) { showStatus('goal-status','âœ… ì‚­ì œ ì™„ë£Œ','success'); loadGoals(); }
    } catch(e) { showStatus('goal-status',`âŒ ${e.message}`,'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRE ë…¹ìŒ (ì•„ì½”ë””ì–¸) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScenarioDropdown() {
    try {
        const res = await fetch('/api/rp-admin/scenarios');
        const data = await res.json();
        const sel = document.getElementById('pre-scenario-id');
        sel.innerHTML = '<option value="">-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ --</option>';
        if (data.scenarios) for (const s of data.scenarios) sel.innerHTML += `<option value="${s.id}">${s.title} (ID: ${s.id})</option>`;
    } catch(e) { console.error(e); }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('pre-scenario-id')?.addEventListener('change', () => {
        const id = document.getElementById('pre-scenario-id').value;
        if (id) loadPreRecordings(id); else document.getElementById('pre-list').innerHTML = '<div class="empty-state">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>';
    });
});

async function loadPreRecordings(scenarioId) {
    try {
        const res = await fetch(`/api/rp-admin/pre-recordings/${scenarioId}`);
        const data = await res.json();
        if (!data.recordings?.length) {
            document.getElementById('pre-list').innerHTML = '<div class="empty-state">ì´ ì‹œë‚˜ë¦¬ì˜¤ì— ë“±ë¡ëœ PREê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™”
        const groups = {};
        for (const r of data.recordings) {
            if (!groups[r.category]) groups[r.category] = { guide: r.guide_text, items: [] };
            groups[r.category].items.push(r);
        }

        let html = '';
        for (const [cat, group] of Object.entries(groups)) {
            const count = group.items.length;
            html += `
            <div class="accordion-header" onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('open');">
                <div style="display:flex; align-items:center; flex:1; min-width:0;">
                    <span class="arrow">â–¶</span>
                    <span class="cat-name" style="margin-left:10px;">${cat}</span>
                    <span class="cat-count">(${count}ê°œ)</span>
                    <span class="cat-guide">${group.guide || ''}</span>
                </div>
            </div>
            <div class="accordion-body">`;

            for (const r of group.items) {
                const urlLink = r.cloudflare_url ? `<a href="${r.cloudflare_url}" target="_blank">ğŸ”— ë§í¬</a>` : '-';
                html += `
                <div class="variant-row">
                    <span class="variant-num">ë³€í˜• ${r.variant}</span>
                    <span class="variant-transcript">${r.transcript||'-'}</span>
                    <span class="variant-url">${urlLink}</span>
                    <span>
                        <button class="btn btn-ghost btn-sm" onclick='editPre(${JSON.stringify(r).replace(/'/g,"&#39;")})' style="padding:3px 8px;font-size:12px;">ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePre(${r.id})" style="padding:3px 8px;font-size:12px;">âœ•</button>
                    </span>
                </div>`;
            }
            html += '</div>';
        }
        document.getElementById('pre-list').innerHTML = html;
    } catch(e) { document.getElementById('pre-list').innerHTML = `<div class="empty-state" style="color:#ff6b6b;">${e.message}</div>`; }
}

function editPre(r) {
    const html = `
    <div class="form-row"><div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><input id="ed-pre-cat" value="${r.category||''}"></div>
    <div class="form-group"><label>ë³€í˜•</label><select id="ed-pre-var"><option value="1" ${r.variant==1?'selected':''}>1</option><option value="2" ${r.variant==2?'selected':''}>2</option><option value="3" ${r.variant==3?'selected':''}>3</option></select></div></div>
    <div class="form-row full"><div class="form-group"><label>ê°€ì´ë“œ</label><input id="ed-pre-guide" value="${r.guide_text||''}"></div></div>
    <div class="form-row full"><div class="form-group"><label>ëŒ€ì‚¬</label><input id="ed-pre-transcript" value="${r.transcript||''}"></div></div>
    <div class="form-row full"><div class="form-group"><label>R2 URL</label><input id="ed-pre-url" value="${r.cloudflare_url||''}"></div></div>`;

    openModal(`PRE ìˆ˜ì • (ID: ${r.id})`, html, async () => {
        const payload = {
            category: document.getElementById('ed-pre-cat').value.trim(),
            variant: parseInt(document.getElementById('ed-pre-var').value),
            guide_text: document.getElementById('ed-pre-guide').value.trim() || null,
            transcript: document.getElementById('ed-pre-transcript').value.trim(),
            cloudflare_url: document.getElementById('ed-pre-url').value.trim() || null
        };
        try {
            const res = await fetch(`/api/rp-admin/pre-recordings/${r.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            if ((await res.json()).success) {
                closeModal(); showStatus('pre-status','âœ… ìˆ˜ì • ì™„ë£Œ','success');
                loadPreRecordings(document.getElementById('pre-scenario-id').value);
            }
        } catch(e) { showStatus('pre-status',`âŒ ${e.message}`,'error'); }
    });
}

async function createPre() {
    const payload = {
        scenario_id: parseInt(document.getElementById('pre-scenario-id').value),
        category: document.getElementById('pre-category').value.trim(),
        variant: parseInt(document.getElementById('pre-variant').value),
        guide_text: document.getElementById('pre-guide').value.trim() || null,
        transcript: document.getElementById('pre-transcript').value.trim(),
        cloudflare_url: document.getElementById('pre-url').value.trim() || null
    };
    if (!payload.scenario_id || !payload.category || !payload.transcript) { showStatus('pre-status','âŒ ì‹œë‚˜ë¦¬ì˜¤, ì¹´í…Œê³ ë¦¬, ëŒ€ì‚¬ í•„ìˆ˜','error'); return; }
    try {
        const res = await fetch('/api/rp-admin/pre-recordings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const data = await res.json();
        if (data.success) { showStatus('pre-status',`âœ… ë“±ë¡ ì™„ë£Œ! (ID: ${data.id})`,'success'); document.getElementById('pre-transcript').value=''; document.getElementById('pre-url').value=''; loadPreRecordings(payload.scenario_id); }
        else showStatus('pre-status',`âŒ ${data.error}`,'error');
    } catch(e) { showStatus('pre-status',`âŒ ${e.message}`,'error'); }
}

async function deletePre(id) {
    if (!confirm('PRE ì‚­ì œ?')) return;
    try {
        const res = await fetch(`/api/rp-admin/pre-recordings/${id}`, { method:'DELETE' });
        if ((await res.json()).success) { showStatus('pre-status','âœ… ì‚­ì œ','success'); loadPreRecordings(document.getElementById('pre-scenario-id').value); }
    } catch(e) { showStatus('pre-status',`âŒ ${e.message}`,'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì´ˆê¸° ë¡œë“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadScenarios();
</script>
</body>
</html>