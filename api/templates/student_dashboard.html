<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Aula di Coreano</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Dark Mode) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1e2124;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        
        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        nav {
            background-color: #282c34;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #202225;
        }
        .nav-title { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .nav-user { font-size: 0.95rem; color: #b9bbbe; }
        .logout-btn {
            background-color: #f04747;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.85rem;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #40444b; }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: #b9bbbe;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active {
            color: #7289da;
            border-bottom: 3px solid #7289da;
            margin-bottom: -2px;
        }

        /* [ì¶”ê°€] ê¸°ë¡ íƒ­ ë‚´ë¶€ í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .sub-tab-btn {
            padding: 8px 16px;
            background-color: #23272a;
            border: 1px solid #40444b;
            color: #b9bbbe;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .sub-tab-btn:hover { background-color: #2c2f33; color: white; }
        .sub-tab-btn.active {
            background-color: #7289da;
            color: white;
            border-color: #7289da;
        }

        /* íƒ­ ì½˜í…ì¸  ì˜ì—­ */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Tab 1: Overview ìŠ¤íƒ€ì¼ --- */
        .stat-card {
            background-color: #2c2f33;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #23272a;
        }

        /* [ì¶”ê°€] ì ìˆ˜ ì¹´ë“œ 3ë¶„í•  ìŠ¤íƒ€ì¼ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background-color: #2c2f33;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #23272a;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-title { font-size: 1rem; color: #b9bbbe; margin-bottom: 10px; font-weight: bold; }
        .stat-score { font-size: 2.5rem; font-weight: bold; color: #fff; }
        
        /* ì ìˆ˜ë³„ í¬ì¸íŠ¸ ìƒ‰ìƒ */
        .stat-score.trans { color: #3498db; } /* íŒŒë‘ */
        .stat-score.comp { color: #2ecc71; }  /* ì´ˆë¡ */
        .stat-score.speak { color: #f1c40f; } /* ë…¸ë‘ */

        .score-display { font-size: 3.5rem; font-weight: bold; color: #2ecc71; margin: 10px 0; }
        .action-btn {
            background-color: #7289da;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* --- Tab 2: í•™ìŠµ ì‹œì‘ ìŠ¤íƒ€ì¼ --- */
        .start-box {
            background-color: #2c2f33;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background-color: #202225;
            border: 1px solid #40444b;
            color: white;
            border-radius: 5px;
            font-size: 1rem;
        }
        .start-quiz-btn {
            width: 100%;
            padding: 15px;
            background-color: #27ae60;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* --- Tab 3: ê¸°ë¡ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ìš°ë¦¬ê°€ ë””ìì¸í•œ ê²ƒ) --- */
        .record-card {
            background-color: #2c2f33;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #23272a;
            position: relative;
        }
        
        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .status-badge {
            position: static; 
            padding: 3px 12px; 
            border-radius: 20px;
            font-size: 0.7rem; 
            font-weight: bold;
            display: inline-flex; 
            align-items: center; 
            gap: 3px;
            white-space: nowrap;
        }
        .status-badge.pending { background-color: rgba(230, 126, 34, 0.15); color: #e67e22; border: 1px solid #e67e22; }
        .status-badge.checked { background-color: rgba(39, 174, 96, 0.15); color: #2ecc71; border: 1px solid #2ecc71; }

        .recognized-text {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffffff;
            margin-top: 10px;
            line-height: 1.5;
        }

        .header-row { 
            display: flex; 
            justify-content: space-between;
            align-items: flex-start; 
            margin-bottom: 15px; 
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .score-circle {
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            background-color: #23272a; 
            border: 3px solid #f1c40f;
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #fff;
            flex-shrink: 0;
        }
        .quiz-title { 
            font-weight: bold; 
            font-size: 1.1rem; 
            color: white; 
            margin: 2px 0 4px 0;
            line-height: 1.2;
        }

        .header-label {
            font-size: 0.85rem;
            color: #7289da; /* í¬ì¸íŠ¸ ì»¬ëŸ¬ */
            font-weight: bold;
            text-transform: uppercase; /* ëŒ€ë¬¸ì ë³€í™˜ */
        }

        .date-info { color: #99aab5; font-size: 0.9rem; }

        .content-box {
            background-color: #202225;
            padding: 15px; border-radius: 8px;
            margin-bottom: 15px; color: #e0e0e0;
        }
        .content-label { color: #7289da; font-size: 0.85rem; margin-bottom: 8px; font-weight: bold; }
        
        /* í”¼ë“œë°± ë°•ìŠ¤ */
        .teacher-feedback-box {
            background-color: #2f3136;
            border-left: 4px solid #2ecc71;
            padding: 15px; border-radius: 4px; margin-top: 15px;
        }
        .teacher-label { color: #2ecc71; font-weight: bold; margin-bottom: 5px; }
        
        /* ëª¨ë‹¬ (ì •ë³´ ìˆ˜ì •) */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal-content { 
            background: #2c2f33; 
            width: 90%; 
            max-width: 400px; 
            margin: 10% auto; 
            padding: 30px; 
            border-radius: 10px; 
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: #40444b; /* ì–´ë‘ìš´ ë°°ê²½ */
            border: 1px solid #202225;
            color: #e0e0e0; /* ê¸€ììƒ‰ ë°ê²Œ */
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box; /* â˜… í•µì‹¬: ì¹¸ì´ ì‚ì ¸ë‚˜ê°€ì§€ ì•Šê²Œ í•¨ */
        }
        .modal-input:focus { outline: none; border-color: #7289da; }
        
    </style>
</head>
<body>

<nav>
    <div class="nav-title">Aula di Coreano</div>
    <div class="nav-user">
        Ciao, <span id="user-name-display">{{ student_name }}</span>!
        <button class="logout-btn" onclick="location.href='/logout'">Esci</button>
    </div>
</nav>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('overview')">Overview</button>
        <button class="tab-btn" onclick="openTab('study')">Inizia Quiz</button>
        <button class="tab-btn" onclick="openTab('history')">Cronologia</button>
    </div>

    <div id="overview" class="tab-content active">

        <h2 style="color: white; margin-bottom: 20px; text-align: center;">Il Tuo Progresso (ë‚˜ì˜ í•™ìŠµ í˜„í™©)</h2>
        
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-title">Traduzione (ë²ˆì—­)</div>
                <div class="stat-score" id="score-trans">--</div> <p style="font-size: 0.9rem; color: #b9bbbe; margin-top: 5px;">
                    <span id="count-trans">0</span> tentativi (ì‹œë„)
                </p>
            </div>
            
            <div class="stat-box">
                <div class="stat-title">Comprensione (ì´í•´ë ¥)</div>
                <div class="stat-score comp" id="score-comp">--</div>
                <p style="font-size: 0.9rem; color: #b9bbbe; margin-top: 5px;">
                    <span id="count-comp">0</span> tentativi (ì‹œë„)
                </p>
            </div>
            
            <div class="stat-box">
                <div class="stat-title">Parlato (ë§í•˜ê¸°)</div>
                <div class="stat-score speak" id="score-speak">--</div>
                <p style="font-size: 0.9rem; color: #b9bbbe; margin-top: 5px;">
                    <span id="count-speak">0</span> tentativi (ì‹œë„)
                </p>      
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="action-btn" onclick="openModal()">âœï¸ Modifica Profilo (ë‚´ ì •ë³´ ìˆ˜ì •)</button>
        </div>

    </div>

    <div id="study" class="tab-content">
        <div class="start-box">
            <h2 style="color:white; margin-bottom: 20px;">Seleziona la Lezione</h2>
            
            <select id="class-select">
                <option value="" disabled selected>Scegli la tua classe (ë°˜ ì„ íƒ)</option>
                <option value="siena-beginner">ì´ˆê¸‰ë°˜ (Principianti)</option>
                <option value="siena-3">3í•™ë…„ (Triennale 3)</option>
                <option value="siena-master-1">ì„ì‚¬ 1í•™ë…„ (Magistrale 1)</option>
                <option value="siena-master-2">ì„ì‚¬ 2í•™ë…„ (Magistrale 2)</option>
            </select>

            <select id="type-select">
                <option value="" disabled selected>Tipo di Quiz (ìœ í˜• ì„ íƒ)</option>
                <option value="translation">Traduzione (ë²ˆì—­)</option>
                <option value="comprehension">Comprensione (ì´í•´ë ¥)</option>
                <option value="speaking">Parlato (ë§í•˜ê¸°)</option>
            </select>

            <button class="start-quiz-btn" onclick="startQuiz()">ğŸš€ Inizia (ì‹œì‘í•˜ê¸°)</button>
        </div>
    </div>

    <div id="history" class="tab-content">
       
        <div class="sub-tabs">
            <button class="sub-tab-btn" onclick="filterHistory('comprehension')">Comprensione (ì´í•´ë ¥)</button>
            <button class="sub-tab-btn" onclick="filterHistory('speaking')">Parlato (ë§í•˜ê¸°)</button>
        </div>        
        
        <div id="history-list">
            <p style="text-align: center; color: #777; margin-top: 50px;">Caricamento...</p>
        </div>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <h3 style="color: white; margin-top: 0; margin-bottom: 20px; text-align: center;">Modifica Profilo</h3>
        
        <label style="color: #b9bbbe; font-size: 0.9rem;">Nome Completo</label>
        <input type="text" id="edit-fullname" class="modal-input" placeholder="Nome Completo">
        
        <label style="color: #b9bbbe; font-size: 0.9rem;">Matricola (í•™ë²ˆ)</label>
        <input type="text" id="edit-student-num" class="modal-input" placeholder="Matricola">
        
        <label style="color: #b9bbbe; font-size: 0.9rem;">Email</label>
        <input type="email" id="edit-email" class="modal-input" placeholder="Email">
        
        <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">
        
        <label style="color: #b9bbbe; font-size: 0.9rem;">Nuova Password (ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</label>
        <input type="password" id="edit-password" class="modal-input" placeholder="Nuova Password">
        
        <label style="color: #b9bbbe; font-size: 0.9rem;">Conferma Password (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)</label>
        <input type="password" id="edit-confirm-password" class="modal-input" placeholder="Ripeti Nuova Password">
        
        <button class="action-btn" style="width:100%; margin-top: 10px;" onclick="submitProfileUpdate()">Salva (ì €ì¥)</button>
        <button class="action-btn" style="width:100%; background-color:#555; margin-top:10px;" onclick="closeModal()">Annulla (ì·¨ì†Œ)</button>
    </div>
</div>

<script>
    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        // íƒ­ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì°¾ê¸° (ê°„ëµí™”)
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName === 'overview') btns[0].classList.add('active');
        if(tabName === 'study') btns[1].classList.add('active');
        if(tabName === 'history') btns[2].classList.add('active');
    }

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', loadDashboardData);

    let currentUserInfo = {}; // ìˆ˜ì •ìš©

    async function loadDashboardData() {
        try {
            const res = await fetch('/api/student-dashboard-data');
            const data = await res.json();

            if (data.error) { alert('Errore: ' + data.error); return; }

            // 1. Overview
            if (data.trans_stats) {
                const el = document.getElementById('score-trans');
                el.textContent = data.trans_stats.avg;
                el.style.color = data.trans_stats.color; // â˜… ìƒ‰ìƒ ì ìš©
                document.getElementById('count-trans').textContent = data.trans_stats.count; // â˜… íšŸìˆ˜ ì ìš©
            }

            if (data.comp_stats) {
                const el = document.getElementById('score-comp');
                el.textContent = data.comp_stats.avg;
                el.style.color = data.comp_stats.color;
                document.getElementById('count-comp').textContent = data.comp_stats.count;
            }

            if (data.speak_stats) {
                const el = document.getElementById('score-speak');
                el.textContent = data.speak_stats.avg;
                el.style.color = data.speak_stats.color;
                document.getElementById('count-speak').textContent = data.speak_stats.count;
            }

            currentUserInfo = data.user_info; // ì €ì¥í•´ë‘ 

            // 2. History (ë§í•˜ê¸° + ì´í•´ë ¥ í•©ì³ì„œ ìµœì‹ ìˆœ ì •ë ¬ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬)
            // í˜„ì¬ëŠ” ë°±ì—”ë“œì—ì„œ ê°ê° ìµœì‹ ìˆœìœ¼ë¡œ ì˜´. ë‹¨ìˆœí•˜ê²Œ í•©ì³ì„œ ë³´ì—¬ì¤Œ.
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = '';

            // ë§í•˜ê¸° ì¹´ë“œ ìƒì„±
            data.speaking_logs.forEach(log => {
                const card = createSpeakingCard(log);
                historyContainer.appendChild(card);
            });

            // ì´í•´ë ¥ ì¹´ë“œ ìƒì„±
            data.comprehension_logs.forEach(log => {
                const card = createComprehensionCard(log);
                historyContainer.appendChild(card);
            });

            if (data.speaking_logs.length === 0 && data.comprehension_logs.length === 0) {
                historyContainer.innerHTML = '<p style="text-align:center; color:#777;">Nessuna attivitÃ  recente.</p>';
            }

        } catch (e) {
            console.error(e);
        }
    }

    // ğŸ¤ ë§í•˜ê¸° ì¹´ë“œ ìƒì„± í•¨ìˆ˜
    function createSpeakingCard(log) {
        const div = document.createElement('div');
        div.className = 'record-card type-speaking';
        
        const badgeClass = log.is_checked ? 'checked' : 'pending';
        const badgeText = log.is_checked ? 'âœ… Visto' : 'â³ Attesa';
        const titleText = log.title || '(No Title)';
        const profFeedback = log.teacher_feedback ? 
            `<div class="teacher-feedback-box"><div class="teacher-label">ğŸ‘¨â€ğŸ« Prof's Comment</div><p>${log.teacher_feedback}</p></div>` : '';

        div.innerHTML = `

            <div class="header-row">
                <div class="header-left">
                    <div class="score-circle" style="border-color: ${log.rating_color};">${log.ai_analysis_json.score}</div>
                    <div>
                        <div class="header-label">Situazione</div>
                        <div class="quiz-title">${titleText}</div>
                        <div class="date-info">${log.created_at}</div>
                    </div>
                </div>
                <div class="status-badge ${badgeClass}"><span>${badgeText}</span></div>
            </div>

            <div class="content-box" style="border-left: 3px solid #7289da;">
                <div class="content-label">ğŸ“– Situazione (ìƒí™©)</div>
                <p style="font-size:0.95rem; color:#e0e0e0; margin-bottom: 15px; line-height: 1.5;">${log.situation_description}</p>
                <div class="content-label" style="color: #fff;">ğŸ’¬ Cosa devi dire (ì§€ì‹œë¬¸)</div>
                <p style="font-weight:bold; color: #fff; font-size: 1rem;">"${log.required_expression}"</p>
            </div>

            <div class="content-box">
                <div class="content-label">LA TUA RISPOSTA (Audio)</div>
                <audio controls src="${log.audio_file_url}" style="width:100%; margin-bottom:5px;"></audio>
                <div class="recognized-text">
                    <span style="color: #999; font-size: 0.9rem; font-weight: normal;">Trascrizione:</span><br>
                    ${log.recognized_korean_text}
                </div>
            </div>

            <div class="content-box" style="border-left: 3px solid #3498db;">
                <div class="content-label" style="color: #3498db;">RISPOSTA CORRETTA</div>
                <p style="font-weight:bold;">${log.expected_korean_answer}</p>
            </div>

            <div style="margin-top:10px; color:#b9bbbe; font-size:0.9rem;">
                <strong>ğŸ¤– AI Feedback:</strong> ${log.ai_analysis_json.feedback}
            </div>
            ${profFeedback}

        `;
        return div;
    }

    // ğŸ§  ì´í•´ë ¥ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
    function createComprehensionCard(log) {
        const div = document.createElement('div');
        div.className = 'record-card type-comprehension';
        
        const badgeClass = log.is_checked ? 'checked' : 'pending';
        const badgeText = log.is_checked ? 'âœ… Visto' : 'â³ Attesa';
        const titleText = log.title || '(No Title)';
        const profFeedback = log.teacher_feedback ? 
            `<div class="teacher-feedback-box"><div class="teacher-label">ğŸ‘¨â€ğŸ« Prof's Comment</div><p>${log.teacher_feedback}</p></div>` : '';

        div.innerHTML = `
            <div class="header-row">
                <div class="header-left">
                    <div class="score-circle" style="border-color: ${log.rating_color};">${log.ai_analysis_json.score}</div>
                    <div>
                        <div class="header-label">Dialogo</div>
                        <div class="quiz-title">${titleText}</div>
                        <div class="date-info">${log.created_at}</div>
                    </div>
                </div>
                <div class="status-badge ${badgeClass}"><span>${badgeText}</span></div>
            </div>

            <div class="content-box">
                <div class="content-label">ğŸ”Š DIALOGO ORIGINALE</div>
                <audio controls src="${log.audio_file_path}" style="width:100%; margin-bottom:10px;"></audio>
                <div style="white-space: pre-line; color: #b9bbbe; font-size:0.9rem;">${log.korean_dialogue}</div>
            </div>
            <div class="content-box">
                <div class="content-label">IL TUO RIASSUNTO</div>
                <p>${log.student_answer}</p>
            </div>
            <div style="margin-top:10px; color:#b9bbbe; font-size:0.9rem;">
                <strong>ğŸ¤– AI Feedback:</strong> ${log.ai_analysis_json.feedback}
            </div>
            ${profFeedback}
        `;
        return div;
    }

    // í€´ì¦ˆ ì‹œì‘ (Tab 2)
    async function startQuiz() {
        const className = document.getElementById('class-select').value;
        const quizType = document.getElementById('type-select').value;

        if (!className || !quizType) {
            alert('Seleziona sia la classe che il tipo di quiz!');
            return;
        }

        const res = await fetch('/api/start-quiz', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ class_name: className, quiz_type: quizType })
        });
        
        if (res.ok) {
            window.location.href = '/quiz'; // ë¬¸ì œ í’€ì´ í™”ë©´ìœ¼ë¡œ ì´ë™
        }
    }

    // ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨
    function openModal() {
        document.getElementById('edit-fullname').value = currentUserInfo.full_name || '';
        document.getElementById('edit-student-num').value = currentUserInfo.student_number || '';
        document.getElementById('edit-email').value = currentUserInfo.school_email || '';
        document.getElementById('edit-password').value = '';
        document.getElementById('edit-modal').style.display = 'block';
    }
    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    
    async function submitProfileUpdate() {
        const fullName = document.getElementById('edit-fullname').value;
        const studentNum = document.getElementById('edit-student-num').value;
        const email = document.getElementById('edit-email').value;
        const password = document.getElementById('edit-password').value;
        const confirmPassword = document.getElementById('edit-confirm-password').value; // í™•ì¸ ê°’ ê°€ì ¸ì˜¤ê¸°

        // â˜… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸ ë¡œì§ ì¶”ê°€
        if (password && password !== confirmPassword) {
            alert('Le password non corrispondono! (ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)');
            return;
        }

        const newData = {
            full_name: fullName,
            student_number: studentNum,
            school_email: email,
            password: password 
        };
        
        try {
            const res = await fetch('/api/update-profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newData)
            });
            
            if (res.ok) {
                alert('Profilo aggiornato! (ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤)');
                location.reload();
            } else {
                const err = await res.json();
                alert('Errore: ' + (err.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Errore di connessione');
        }
    }

    // â–¼â–¼â–¼ [ì¶”ê°€] ê¸°ë¡ íƒ­ í•„í„°ë§ í•¨ìˆ˜ (ì—¬ê¸°ì— ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤) â–¼â–¼â–¼
    function filterHistory(type) {
        // 1. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        const buttons = document.querySelectorAll('.sub-tab-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        // í´ë¦­ëœ ë²„íŠ¼(event.target)ì— active í´ë˜ìŠ¤ ì¶”ê°€
        if (event && event.target) {
            event.target.classList.add('active');
        }

        // 2. ì¹´ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
        const allCards = document.querySelectorAll('.record-card');
        allCards.forEach(card => {
            if (type === 'all') {
                card.style.display = 'block';
            } else if (type === 'speaking') {
                card.style.display = card.classList.contains('type-speaking') ? 'block' : 'none';
            } else if (type === 'comprehension') {
                card.style.display = card.classList.contains('type-comprehension') ? 'block' : 'none';
            }
        });
    }
    // â–²â–²â–² [ì¶”ê°€ ë] â–²â–²â–²
</script>

</body>
</html>